// BIMM Market - Full Stack Schema (PostgreSQL for Supabase Production)
// Supports automatic migrations and data sync

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users - for Google Auth users
model User {
  id          String   @id @default(cuid())
  firebaseUid String   @unique
  email       String   @unique
  displayName String?
  photoURL    String?
  level       String   @default("NEWBIE") // NEWBIE, BRONZE, SILVER, GOLD, PLATINUM
  paidCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]
}

// Categories (Main & Sub)
model Category {
  id           String   @id @default(cuid())
  key          String   @unique
  name         String
  isMain       Boolean  @default(false)
  iconUrl      String?
  order        Int      @default(0)
  matchKeywords String?  // comma-separated keywords for auto-sub category matching
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  products     Product[]
  parentId     String?
  parent       Category? @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children     Category[] @relation("CategoryHierarchy")
}

// Products
model Product {
  id             String    @id @default(cuid())
  name           String
  price          Int
  stock          Int?      // null means unlimited
  categoryKey    String
  subCategoryKey String?
  image          String?
  imageUrl       String?
  status         String    @default("available") // available, sold
  available      Boolean   @default(true)
  description    String?
  discountActive Boolean   @default(false)
  discountPercent Int?
  discountStart  DateTime?
  discountEnd    DateTime?
  soldCount      Int       @default(0)
  order          Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  category       Category  @relation(fields: [categoryKey], references: [key])
  orderItems     OrderItem[]
}

// Orders
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String?
  user            User?       @relation(fields: [userId], references: [id])
  name            String
  email           String
  whatsapp        String
  notes           String?
  paymentMethod   String
  total           Int
  status          String      @default("pending") // pending, paid, proses, selesai, canceled
  paymentProofUrl String?
  deliveryData    String?
  items           OrderItem[]
  createdAt       DateTime    @default(now())
  statusUpdatedAt DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// Order Items
model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  name      String
  price     Int
  qty       Int
  image     String?
  createdAt DateTime @default(now())
}

// Payment Methods
model PaymentMethod {
  id           String   @id @default(cuid())
  label        String
  type         String   // qris, bank, ewallet
  account      String?  // bank account number
  holder       String?  // account holder name
  qrisUrl      String?
  qrisImageUrl String?
  order        Int      @default(0)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Announcements
model Announcement {
  id        String   @id @default(cuid())
  title     String
  body      String
  image     String?
  imageUrl  String?
  order     Int      @default(0)
  active    Boolean   @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// About Items
model AboutItem {
  id        String   @id @default(cuid())
  title     String
  subtitle  String?
  icon      String?  // emoji or image URL
  iconUrl   String?
  url       String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Contact/Social Links
model ContactLink {
  id        String   @id @default(cuid())
  type      String   // instagram, tiktok, facebook, link
  label     String
  url       String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// WA Admins
model WaAdmin {
  id        String   @id @default(cuid())
  number    String
  label     String
  order     Int      @default(0)
  active    Boolean   @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Managers (Admin access)
model Manager {
  id        String   @id @default(cuid())
  uid       String   @unique
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Rankings
model Ranking {
  id        String   @id @default(cuid())
  userId    String
  userName  String
  userEmail String?
  totalSpent Int
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Welcome/Banner
model Welcome {
  id        String   @id @default(cuid())
  key       String   @unique @default("home")
  title     String
  subtitle  String?
  imageUrl  String?
  active    Boolean   @default(true)
  updatedAt DateTime @updatedAt
}

// Migration Tracking (untuk auto-sync)
model Migration {
  id            String   @id @default(cuid())
  sourceType    String   @default("sqlite") // sqlite, postgres
  targetType    String   @default("postgres") // postgres
  status        String   @default("pending") // pending, running, completed, failed
  tableName     String
  recordCount   Int      @default(0)
  error         String?
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  createdAt     DateTime @default(now())
}
