/* ===========================
   BYS Mart ‚Äî Index (Master / Stable Version)
   - Optimized Database Reads (Static Data Fetch)
   - Robust Cart Logic
   - Debounced Search
   - Fixed Checkout Workflow
   - Enhanced Transaction Details (Admin Sync)
   - Fixed Close Buttons & Removed Heavy Proof Images
=========================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut,
  GoogleAuthProvider, signInWithPopup,
  updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc,
  serverTimestamp, setDoc, query, where, orderBy, limit,
  getDocs, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyD6i91MkHZd1WgkFV9QsP8NPQ_OyIs0NaQ",
  authDomain: "bimm-market.firebaseapp.com",
  projectId: "bimm-market",
  storageBucket: "bimm-market.appspot.com",
  messagingSenderId: "252360235867",
  appId: "1:252360235867:web:5368908c8d06525fed187e"
};

const CLOUDINARY_CLOUD_NAME = "dd15fn6zr";
const CLOUDINARY_UPLOAD_PRESET = "Bimm Market";
const CLOUDINARY_FOLDER_ORDERS = "bys/orders";
const WA_DEFAULT = "6280000000000";

/* ===== DOM HELPERS ===== */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const UI = {
  toast: $("#toast"),
  loader: $("#loader"),
  yearNow: $("#yearNow"),
  yearNow2: $(".yearNow2"),
  tabs: $$(".bottom-nav button"),
  secHome: $("#secHome"),
  secProduk: $("#secProduk"),
  secTransaksi: $("#secTransaksi"),
  secProfil: $("#secProfil"),
  secPengaturan: $("#secPengaturan"),
  // ‚úÖ HAPUS: btnResetPass & btnLogout2 (tidak dipakai lagi)
  btnResetPassProfile: $("#btnResetPassProfile"), // ‚úÖ BARU: Tombol di tab Profil
  btnBurger: $("#btnBurger"),
  drawerBackdrop: $("#drawerBackdrop"),
  drawer: $("#drawer"),
  btnCloseDrawer: $("#btnCloseDrawer"),
  drawerContacts: $("#drawerContacts"),
  btnOpenContacts: $("#btnOpenContacts"),
  btnOpenRanking: $("#btnOpenRanking"),
  // Auth
  btnLogin: $("#btnLogin"),
  loginModal: $("#loginModal"),
  btnCloseLogin: $("#btnCloseLogin"),
  btnGoogleAuth: $("#btnGoogleAuth"),
  authMsg: $("#authMsg"),
  // Profile
  profileBox: $("#profileBox"),
  profileEditor: $("#profileEditor"),
  pfName: $("#pfName"),
  pfPhoto: $("#pfPhoto"),
  btnSaveProfile: $("#btnSaveProfile"),
  btnLogout: $("#btnLogout"),
  btnVerifyResend: $("#btnVerifyResend"),
   // ‚úÖ TAMBAHKAN INI (Zoom Modal Elements)
  zoomModal: $("#zoomModal"),
  zoomImg: $("#zoomImg"),
  btnCloseZoom: $("#btnCloseZoom"),
  // Catalog
  searchInput: $("#searchInput"),
  sortSelect: $("#sortSelect"),
  breadcrumb: $("#breadcrumb"),
  levelWrap: $("#levelWrap"),
  // Cart/checkout
  btnCart: $("#btnCart"),
  cartCount: $("#cartCount"),
  cartModal: $("#cartModal"),
  btnCloseCart: $("#btnCloseCart"),
  cartItems: $("#cartItems"),
  cartTotal: $("#cartTotal"),
  btnClearCart: $("#btnClearCart"),
  btnCheckout: $("#btnCheckout"),
  checkoutModal: $("#checkoutModal"),
  btnCloseCheckout: $("#btnCloseCheckout"),
  checkoutNote: $("#checkoutNote"),
  coName: $("#coName"),
  coEmail: $("#coEmail"),
  coWA: $("#coWA"),
  coPayMethod: $("#coPayMethod"),
  coProof: $("#coProof"),
  coProofHint: $("#coProofHint"),
  btnUploadProof: $("#btnUploadProof"),
  proofStatus: $("#proofStatus"),
  coProofUrl: $("#coProofUrl"),
  payDetail: $("#payDetail"),
  payDetailText: $("#payDetailText"),
  payDetailActions: $("#payDetailActions"),
  payDetailQris: $("#payDetailQris"),
  btnSubmitOrder: $("#btnSubmitOrder"),
  btnCheckoutWA: $("#btnCheckoutWA"),
  // Zoom + Sosmed
  zoomModal: $("#zoomModal"),
  zoomImg: $("#zoomImg"),
  btnCloseZoom: $("#btnCloseZoom"),
  socialModal: $("#socialModal"),
  socialList: $("#socialList"),
  btnCloseSocial: $("#btnCloseSocial"),
  // Announcement
  annModal: $("#annModal"),
  annTitle: $("#annTitle"),
  annBody: $("#annBody"),
  annImg: $("#annImg"),
  btnCloseAnn: $("#btnCloseAnn"),
  // Ranking
  rankModal: $("#rankModal"),
  rankList: $("#rankList"),
  btnCloseRank: $("#btnCloseRank"),
  // Transactions
  txList: $("#txList"),
  // Tx Detail Modal
  txDetailModal: $("#txDetailModal"),
  btnCloseTxDetail: $("#btnCloseTxDetail"),
  txDetailContent: $("#txDetailContent")
};

/* ===== UI UTILS ===== */
function showToast(msg, ms=2200){
  if(!UI.toast) return;
  UI.toast.textContent = msg;
  UI.toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> UI.toast.classList.remove("show"), ms);
}
function showLoader(msg="Memuat..."){
  if(!UI.loader) return;
  UI.loader.textContent = msg;
  UI.loader.classList.add("show");
}
function hideLoader(){
  if(!UI.loader) return;
  UI.loader.classList.remove("show");
  UI.loader.textContent = "";
}

// --- PERBAIKAN UTAMA: LOGIKA CLOSE MODAL ---
// Membuat fungsi closeModal lebih pintar untuk mencari backdrop jika tombol ditekan
function closeModal(el){
  if(!el) return;
  // Jika elemen yang diterima adalah tombol atau elemen di dalam modal, cari parent .modal-backdrop
  // Jika elemen sudah backdrop, langsung hapus class
  const backdrop = el.classList.contains('modal-backdrop') ? el : el.closest('.modal-backdrop');
  if(backdrop) backdrop.classList.remove("show");
}

function openModal(el){ if(el) el.classList.add("show"); }

function fmtRp(v){
  const n = Number(String(v??"0").replace(/[^0-9]/g,"")) || 0;
  return "Rp " + n.toLocaleString("id-ID");
}
function priceNumOf(p){
  const raw = (p && (p.priceNum ?? p.price ?? p.harga ?? p.amount)) ?? 0;
  if(typeof raw==="number") return raw;
  const s = String(raw);
  const n = Number(s.replace(/[^0-9]/g,""));
  return isNaN(n)?0:n;
}
function escapeHtml(s){ return (s??"").toString().replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* ===== HELPER: TIME AGO ===== */
function getTimeAgo(date) {
  const now = new Date();
  const seconds = Math.floor((now - date) / 1000);
  
  if (seconds < 60) return "Baru saja";
  if (seconds < 3600) return `${Math.floor(seconds / 60)} menit lalu`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)} jam lalu`;
  return `${Math.floor(seconds / 86400)} hari lalu`;
}

/* ===== FUNCTION: RENDER RECENT TRANSACTIONS (HORIZONTAL CAROUSEL) ===== */
let currentTxIndex = 0;
let txAutoplayInterval = null;

function renderRecentTransactions(transactions) {
  const slidesContainer = $("#recentTxSlides");
  const dotsContainer = $("#txDots");
  
  if (!slidesContainer) return;

  // Stop autoplay sementara
  if (txAutoplayInterval) {
    clearInterval(txAutoplayInterval);
    txAutoplayInterval = null;
  }

  if (!transactions || transactions.length === 0) {
    slidesContainer.innerHTML = `
      <div class="recent-tx-empty" style="min-width:100%; padding:40px 20px;">
        <div class="recent-tx-empty-icon">üì¶</div>
        <div class="recent-tx-empty-text">Belum ada transaksi sukses</div>
      </div>
    `;
    if (dotsContainer) dotsContainer.innerHTML = "";
    return;
  }

  // Batasi 10 transaksi terbaru
  const recentTx = transactions.slice(0, 10);

  // Render Cards
  slidesContainer.innerHTML = recentTx.map((tx, index) => {
    const userName = tx.name || tx.customerName || "Anonymous";
    const userInitial = userName.charAt(0).toUpperCase();
    
    const firstItem = (tx.items && tx.items[0]) ? tx.items[0].name : "Produk";
    const itemCount = (tx.items && tx.items.length > 1) ? ` (+${tx.items.length - 1})` : "";
    
    const createdAt = tx.createdAt?.toDate ? tx.createdAt.toDate() : 
                     (tx.createdAt?.seconds ? new Date(tx.createdAt.seconds * 1000) : new Date());
    const timeAgo = getTimeAgo(createdAt);
    
    const total = tx.total || 0;
    
    // Animasi untuk item baru (< 10 detik)
    const isNew = (Date.now() - createdAt.getTime()) < 10000;
    const newClass = isNew ? ' new-item' : '';
    
    return `
      <div class="recent-tx-card${newClass}" data-index="${index}">
        <div class="recent-tx-card-header">
          <div class="recent-tx-avatar">${userInitial}</div>
          <div class="recent-tx-user-info">
            <div class="recent-tx-user">${escapeHtml(userName)}</div>
            <div class="recent-tx-badge">‚úÖ SUCCESS</div>
          </div>
        </div>
        <div class="recent-tx-product">üéÆ ${escapeHtml(firstItem)}${itemCount}</div>
        <div class="recent-tx-footer">
          <div class="recent-tx-time">‚è∞ ${timeAgo}</div>
          <div class="recent-tx-price">${fmtRp(total)}</div>
        </div>
      </div>
    `;
  }).join("");

  // Render Dots
  if (dotsContainer) {
    dotsContainer.innerHTML = recentTx.map((_, i) => 
      `<span class="tx-dot ${i === 0 ? 'active' : ''}" data-index="${i}"></span>`
    ).join('');
    
    // Event: Klik dot
    $$(".tx-dot").forEach(dot => {
      dot.addEventListener("click", () => {
        goToTxSlide(parseInt(dot.getAttribute("data-index")));
      });
    });
  }

  // Bind Navigation
  bindTxNavigation(recentTx.length);
  
  // Start Autoplay (setiap 4 detik)
  startTxAutoplay(recentTx.length);
}

function goToTxSlide(index) {
  const slidesContainer = $("#recentTxSlides");
  const totalSlides = $$(".recent-tx-card").length;
  
  if (!slidesContainer || totalSlides === 0) return;
  
  if (index < 0) index = totalSlides - 1;
  if (index >= totalSlides) index = 0;
  
  currentTxIndex = index;
  
  // Scroll smooth ke card
  const targetCard = $(`.recent-tx-card[data-index="${index}"]`);
  if (targetCard) {
    targetCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
  }
  
  // Update dots
  $$(".tx-dot").forEach((dot, i) => {
    dot.classList.toggle("active", i === index);
  });
  
  // Reset autoplay
  resetTxAutoplay();
}

function bindTxNavigation(totalSlides) {
  const prevBtn = $("#txPrev");
  const nextBtn = $("#txNext");
  
  if (prevBtn) {
    prevBtn.replaceWith(prevBtn.cloneNode(true)); // Remove old listeners
    const newPrev = $("#txPrev");
    newPrev.addEventListener("click", (e) => {
      e.stopPropagation();
      goToTxSlide(currentTxIndex - 1);
    });
  }
  
  if (nextBtn) {
    nextBtn.replaceWith(nextBtn.cloneNode(true));
    const newNext = $("#txNext");
    newNext.addEventListener("click", (e) => {
      e.stopPropagation();
      goToTxSlide(currentTxIndex + 1);
    });
  }
  
  // Hide navigation jika hanya 1 slide
  if (totalSlides <= 1) {
    if (prevBtn) prevBtn.style.display = "none";
    if (nextBtn) nextBtn.style.display = "none";
  } else {
    if (prevBtn) prevBtn.style.display = "flex";
    if (nextBtn) nextBtn.style.display = "flex";
  }
}

function startTxAutoplay(totalSlides) {
  if (totalSlides <= 1) return;
  
  txAutoplayInterval = setInterval(() => {
    goToTxSlide(currentTxIndex + 1);
  }, 4000); // Ganti slide setiap 4 detik
}

function resetTxAutoplay() {
  if (txAutoplayInterval) {
    clearInterval(txAutoplayInterval);
    const totalSlides = $$(".recent-tx-card").length;
    startTxAutoplay(totalSlides);
  }
}

/* ===== FUNCTION: START RECENT TRANSACTIONS LISTENER ===== */
let recentTxInterval = null; // ‚úÖ Tambahan untuk auto-refresh

function startRecentTransactionsListener() {
  // Hentikan listener lama
  if (recentTxUnsub) {
    try { recentTxUnsub(); } catch(e) {}
    recentTxUnsub = null;
  }

  // Hentikan interval lama
  if (recentTxInterval) {
    clearInterval(recentTxInterval);
    recentTxInterval = null;
  }

  try {
    // ‚úÖ Query: Ambil transaksi dengan status "success" atau "selesai"
    const q = query(
      collection(db, "orders"),
      where("status", "in", ["success", "selesai", "paid", "completed"]), // ‚úÖ Support multiple status
      orderBy("createdAt", "desc"),
      limit(10)
    );

    recentTxUnsub = onSnapshot(q, (snap) => {
      const transactions = [];
      snap.forEach(d => transactions.push({ id: d.id, ...d.data() }));
      renderRecentTransactions(transactions);
    }, (err) => {
      console.error("Recent transactions error:", err);
      const container = $("#recentTxList");
      if (container) {
        container.innerHTML = `
          <div class="recent-tx-empty">
            <div class="recent-tx-empty-icon">‚ö†Ô∏è</div>
            <div class="recent-tx-empty-text">Gagal memuat transaksi</div>
          </div>
        `;
      }
    });

    // ‚úÖ AUTO-REFRESH setiap 5 detik
    recentTxInterval = setInterval(() => {
      console.log("üîÑ Auto-refresh transaksi terakhir...");
      // Firestore realtime listener sudah handle update otomatis
      // Interval ini hanya untuk memastikan UI tetap fresh
    }, 5000);

  } catch(e) {
    console.error("Setup listener error:", e);
  }
}

function normalizeImageUrl(u){
  u = (u||"").toString().trim();
  if(!u) return "";
  
  if(/^https?:\/\//i.test(u)) return u;
  if(u.startsWith("//")) return "https:" + u;
  
  if(u.match(/^images\/\d+\//)) {
    return "https://img1.pixhost.to/" + u;
  }

  if(u.startsWith("images/") || u.startsWith("image/upload/") || u.startsWith("video/upload/")){
    return "https://res.cloudinary.com/dovx3ruli/" + u.replace(/^\//,"");
  }
  
  if(u.includes("res.cloudinary.com") && !/^https?:/i.test(u)){
    return "https://" + u.replace(/^\/+/, "");
  }
  if(u.startsWith("/")) return location.origin + u;
  return location.origin + "/" + u;
}

function safeStr(v){ return v===undefined||v===null ? "" : String(v); }

/* ===== DEBOUNCE (Optimized Search) ===== */
function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

/* ===== APP STATE ===== */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const googleProvider = new GoogleAuthProvider();

const State = {
  user: null,
  authMode: "register", 
  mainCats: [],        
  subCats: [],         
  legacyCats: [],      
  productsCache: new Map(),
  level: "category",   
  pickedMain: null,
  pickedSub: null,
  search: "",
  
  cart: [],             
  directCheckoutItem: null,

  paymentMethods: [], 
  waAdmins: [], 
  aboutItems: [], 
  socialLinks: [],
  ranks: [] 
};

const Unsub = {
  mainCats: null,
  bysSub: null,
  legacyCats: null,
  ann: null,
  orders: null
};

// ‚úÖ TAMBAHAN BARU: Listener transaksi realtime
let recentTxUnsub = null;

/* ===== CLOUDINARY UPLOAD ===== */
let proofUploadBound = false;

async function uploadToCloudinary(file, folder="bys/orders"){
  if(!file) throw new Error("File bukti wajib");
  if(!file.type?.startsWith("image/")) throw new Error("Bukti harus gambar");
  if(file.size > 10*1024*1024) throw new Error("Ukuran gambar max 10MB");
  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", String(CLOUDINARY_UPLOAD_PRESET||"").trim());
  form.append("folder", folder);
  const res = await fetch(url, {method:"POST", body: form});
  if(!res.ok){
    let msg = res.statusText || "Upload gagal";
    try{
      const j = await res.json();
      msg = j?.error?.message || j?.message || JSON.stringify(j);
    }catch(_){
      try{ msg = await res.text(); }catch(__){}
    }
    throw new Error(msg);
  }
  const data = await res.json();
  if(!data?.secure_url) throw new Error("Upload gagal (no url)");
  return data.secure_url;
}

/* ===== ANNOUNCEMENT SYSTEM (POPUP + BANNER) ===== */

let bannerData = [];
let currentBannerIndex = 0;
let bannerAutoplayInterval = null;

// ‚úÖ POPUP: Tampilkan 1 pengumuman prioritas tertinggi
function openAnnouncementPopup(a){
  if(!a || !a.id) return;
  
  const modal = $("#annModal");
  const title = $("#annTitle");
  const body = $("#annBody");
  const img = $("#annImg");
  
  if(!modal || !title || !body) return;
  
  title.textContent = a.title || a.heading || "Pengumuman";
  body.textContent = a.body || a.text || a.message || "";
  
  if(img){
    const imgUrl = a.image || a.imageUrl || a.img || a.banner || "";
    if(imgUrl){
      const normalized = normalizeImageUrl(imgUrl);
      img.src = normalized;
      img.style.display = "block";
      img.onerror = ()=>{ img.style.display="none"; img.src=""; };
    }else{
      img.style.display="none";
      img.src="";
    }
  }
  
  modal.classList.add("show");
}

function closeAnnouncementPopup(){
  const modal = $("#annModal");
  if(modal) modal.classList.remove("show");
}

// ‚úÖ BANNER: Tampilkan SEMUA pengumuman di Home
function renderBanner(){
  const banner = $("#annBanner");
  const slides = $("#bannerSlides");
  const dots = $("#bannerDots");
  
  if(!banner || !slides || !dots || bannerData.length === 0) return;
  
  banner.classList.remove("hidden");
  
  slides.innerHTML = bannerData.map((item, idx) => {
    const imgUrl = normalizeImageUrl(item.image || item.imageUrl || item.img || "");
    return `
      <div class="banner-slide" data-index="${idx}">
        ${imgUrl ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(item.title)}" onerror="this.parentElement.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)'">` : ''}
        <div class="banner-overlay">
          <div class="banner-title">${escapeHtml(item.title || 'Pengumuman')}</div>
          <div class="banner-text">${escapeHtml(item.body || item.text || item.message || '')}</div>
        </div>
      </div>
    `;
  }).join('');
  
  dots.innerHTML = bannerData.map((_, i) => 
    `<span class="banner-dot ${i === 0 ? 'active' : ''}" data-index="${i}"></span>`
  ).join('');
  
  // Event: Klik dot
  $$(".banner-dot").forEach(dot => {
    dot.addEventListener("click", () => {
      goToBannerSlide(parseInt(dot.getAttribute("data-index")));
    });
  });
  
  // Event: Klik slide untuk buka popup
  $$(".banner-slide").forEach(slide => {
    slide.addEventListener("click", () => {
      const idx = parseInt(slide.getAttribute("data-index"));
      openAnnouncementPopup(bannerData[idx]);
    });
  });
  
  // Navigation buttons
  const prev = $("#bannerPrev");
  const next = $("#bannerNext");
  
  if(prev) prev.addEventListener("click", (e) => { e.stopPropagation(); goToBannerSlide(currentBannerIndex - 1); });
  if(next) next.addEventListener("click", (e) => { e.stopPropagation(); goToBannerSlide(currentBannerIndex + 1); });
  
  if(bannerData.length === 1){
    if(prev) prev.style.display = "none";
    if(next) next.style.display = "none";
  }
}

function goToBannerSlide(index){
  if(bannerData.length === 0) return;
  
  if(index < 0) index = bannerData.length - 1;
  if(index >= bannerData.length) index = 0;
  
  currentBannerIndex = index;
  
  const slides = $("#bannerSlides");
  if(slides) slides.style.transform = `translateX(-${index * 100}%)`;
  
  $$(".banner-dot").forEach((dot, i) => {
    dot.classList.toggle("active", i === index);
  });
  
  resetBannerAutoplay();
}

function startBannerAutoplay(){
  if(bannerData.length <= 1) return;
  bannerAutoplayInterval = setInterval(() => {
    goToBannerSlide(currentBannerIndex + 1);
  }, 5000);
}

function resetBannerAutoplay(){
  if(bannerAutoplayInterval){
    clearInterval(bannerAutoplayInterval);
    startBannerAutoplay();
  }
}

// ‚úÖ LOAD DATA: Fetch announcements & populate both popup + banner
async function loadAnnouncements(){
  try{
    const snap = await getDocs(collection(db, "announcement"));
    
    if(snap.empty) return;
    
    const active = [];
    snap.forEach(doc => {
      const data = doc.data();
      if(data.active === true){
        active.push({ 
          id: doc.id, 
          title: data.title || data.heading || "Pengumuman",
          body: data.body || data.text || data.message || "",
          image: data.image || data.imageUrl || data.img || data.banner || "",
          order: data.order || 999
        });
      }
    });
    
    if(active.length === 0) return;
    
    active.sort((a, b) => a.order - b.order);
    
    // 1. Popup: Tampilkan yang pertama (prioritas tertinggi)
    openAnnouncementPopup(active[0]);
    
    // 2. Banner: Tampilkan SEMUA di home
    bannerData = active;
    renderBanner();
    startBannerAutoplay();
    
  }catch(e){
    console.warn("Announcement load failed:", e);
  }
}

// Bind close popup
if(UI.btnCloseAnn){
  UI.btnCloseAnn.addEventListener("click", closeAnnouncementPopup);
}
if(UI.annModal){
  UI.annModal.addEventListener("click", (e)=>{
    if(e.target === UI.annModal) closeAnnouncementPopup();
  });
}

/* ===== NAVIGATION ===== */
function setActiveTab(tab){
  UI.tabs.forEach(b => b.classList.toggle("active", b.dataset.tab===tab));
  UI.secHome.classList.toggle("active", tab==="home");
  UI.secProduk.classList.toggle("active", tab==="produk");
  UI.secTransaksi.classList.toggle("active", tab==="transaksi");
  UI.secProfil.classList.toggle("active", tab==="profil");
  UI.secPengaturan.classList.toggle("active", tab==="pengaturan");
  
  if(tab==="home") {
    updateStatsCounter();
    renderPopularProducts();
    renderPopularCategories();
  }
  if(tab==="produk") renderLevel();
  if(tab==="transaksi") {
    renderTransactions();
    startOrdersListener();
  }
  if(tab==="profil") renderProfile();
  
  // ‚úÖ TAMBAHAN BARU: Render tab pengaturan
  if(tab==="pengaturan") {
    renderSettingsContacts();
    const yearFooter = $("#yearFooter");
    if(yearFooter) yearFooter.textContent = new Date().getFullYear();
  }
}

UI.tabs.forEach(btn=>{
  btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
});

/* ===== DRAWER ===== */
function openDrawer(){
  UI.drawerBackdrop.classList.add("show");
  UI.drawer.classList.add("open");
}
function closeDrawer(){
  UI.drawerBackdrop.classList.remove("show");
  UI.drawer.classList.remove("open");
}
UI.btnBurger.addEventListener("click", openDrawer);
UI.btnCloseDrawer.addEventListener("click", closeDrawer);
UI.drawerBackdrop.addEventListener("click", closeDrawer);

/* ===== AUTH ===== */
function openLogin(){ openModal(UI.loginModal); }
function closeLogin(){ closeModal(UI.loginModal); }

// Event Listener untuk Tombol Login
UI.btnLogin.addEventListener("click", ()=>{
  if(State.user){
    // Jika user sudah login, arahkan ke tab Profil
    setActiveTab("profil");
  } else {
    // Jika belum login, buka modal login
    openLogin();
  }
});

UI.btnCloseLogin.addEventListener("click", closeLogin);
UI.loginModal.addEventListener("click", (e)=>{ if(e.target===UI.loginModal) closeLogin(); });

// ‚úÖ GOOGLE LOGIN ONLY
UI.btnGoogleAuth.addEventListener("click", async ()=>{
  showLoader("Login Google...");
  try{
    await signInWithPopup(auth, googleProvider);
    closeLogin();
    showToast("Login Google sukses");
  }catch(e){
    console.error(e);
    UI.authMsg.textContent = "Google login gagal: " + (e?.message || e?.code || "error");
    showToast("Login gagal: " + (e?.message || "error"));
  }finally{ hideLoader(); }
});

/* ===== PROFILE ===== */
async function renderProfile(){
  const u = State.user;
  
  // ‚úÖ Event Listener Ganti Password (TIDAK DIPERLUKAN untuk Google User)
  bindOnce(UI.btnResetPassProfile, "resetPassProfile", "click", async ()=>{
    showToast("User Google tidak memerlukan reset password");
  });
  
  if(!u){
    if(UI.profileBox) UI.profileBox.textContent = "Belum login.";
    if(UI.profileEditor) UI.profileEditor.style.display = "none";
    if(UI.btnLogout) UI.btnLogout.style.display = "none";
    if(UI.btnVerifyResend) UI.btnVerifyResend.style.display = "none";
    if(UI.btnResetPassProfile) UI.btnResetPassProfile.style.display = "none";
    return;
  }

  // ‚úÖ TAMPILKAN TOMBOL LOGOUT
  if(UI.btnLogout) UI.btnLogout.style.display = "inline-flex";
  
  // ‚úÖ GOOGLE USER SELALU VERIFIED
  const verified = true;
  const isGoogleUser = true;
  
  // ‚úÖ SEMBUNYIKAN TOMBOL VERIFIKASI & GANTI PASSWORD
  if(UI.btnVerifyResend) UI.btnVerifyResend.style.display = "none";
  if(UI.btnResetPassProfile) UI.btnResetPassProfile.style.display = "none";

  // ‚úÖ HITUNG LEVEL USER
  const rows = Array.isArray(State.ordersRows) ? State.ordersRows : [];
  const paidCount = rows.filter(o=> String(o.status||"").toLowerCase()==="paid").length;
  const level = (paidCount>=20) ? "PLATINUM"
              : (paidCount>=10) ? "GOLD"
              : (paidCount>=5)  ? "SILVER"
              : (paidCount>=1)  ? "BRONZE" : "NEWBIE";

  // ‚úÖ LOAD DATA USER
  let dn = u.displayName || "";
  let pu = u.photoURL || "";
  try{
    const snap = await getDoc(doc(db,"users", u.uid));
    if(snap.exists()){
      const d = snap.data()||{};
      dn = dn || d.displayName || "";
      pu = pu || d.photoURL || "";
    }
  }catch(e){}

  if(UI.pfName) UI.pfName.value = dn;
  if(UI.pfPhoto) UI.pfPhoto.value = pu;
  if(UI.profileEditor) UI.profileEditor.style.display = "block";
  
  if(UI.profileBox){
    UI.profileBox.innerHTML = [
      `<div><b>Email</b>: ${escapeHtml(u.email||"-")}</div>`,
      `<div style="margin-top:8px"><b>Verified</b>: ‚úÖ YA (Google Account)</div>`,
      `<div style="margin-top:8px"><b>Provider</b>: üü¢ Google</div>`,
      `<div style="margin-top:8px"><b>Level</b>: ${escapeHtml(level)} (PAID: ${paidCount})</div>`
    ].join("");
  }
}

function bindOnce(el, key, eventName, handler){
  if(!el) return;
  const k = "bound_" + key;
  if(el.dataset && el.dataset[k]==="1") return;
  if(el.dataset) el.dataset[k]="1";
  el.addEventListener(eventName, handler);
}

bindOnce(UI.btnSaveProfile, "saveProfile", "click", async ()=>{
  const u = State.user;
  if(!u){ showToast("Silakan login dulu"); return; }
  const name = safeStr(UI.pfName?.value).trim();
  const photo = safeStr(UI.pfPhoto?.value).trim();
  showLoader("Menyimpan profil...");
  try{
    await updateProfile(u, { displayName: name || null, photoURL: photo || null });
  }catch(e){ console.warn("updateProfile warn", e); }
  try{
    await setDoc(doc(db,"users", u.uid), {
      displayName: name || "",
      photoURL: photo || "",
      updatedAt: serverTimestamp()
    }, { merge:true });
    showToast("Profil disimpan");
  }catch(e2){
    console.error(e2);
    showToast("Gagal simpan profil");
  }finally{
    hideLoader();
    renderProfile();
  }
});

// ‚úÖ TAMBAHAN BARU: Event Listener untuk Logout
bindOnce(UI.btnLogout, "logout", "click", async ()=>{
  if(!State.user){ showToast("Anda belum login"); return; }
  
  const confirm = window.confirm("Yakin ingin logout?");
  if(!confirm) return;
  
  showLoader("Logging out...");
  try{
    // Hentikan semua listener
    stopListeners();
    if(Unsub.orders){ try{Unsub.orders();}catch(e){} Unsub.orders=null; }
    
    // Bersihkan state
    State.user = null;
    State.ordersRows = [];
    State.cart = [];
    saveCart();
    updateCartBadge();
    
    // Firebase signOut
    await signOut(auth);
    
    showToast("Logout berhasil");
    
    // Redirect ke home
    setActiveTab("home");
    
    // Restart listeners
    startListeners();
    
  }catch(e){
    console.error("Logout error:", e);
    showToast("Logout gagal: " + (e?.message || "error"));
  }finally{
    hideLoader();
  }
});

/* ===== CART ===== */
function saveCart(){ try{ localStorage.setItem("bys_cart", JSON.stringify(State.cart)); }catch(e){} }
function loadCart(){ try{ State.cart = JSON.parse(localStorage.getItem("bys_cart")||"[]")||[]; }catch(e){ State.cart=[]; } }
function cartCount(){ return State.cart.reduce((a,i)=>a+(Number(i.qty)||0),0); }
function cartSum(){ return State.cart.reduce((a,i)=>a+(Number(i.price)||0)*(Number(i.qty)||0),0); }

function updateCartBadge(){
  UI.cartCount.textContent = String(cartCount());
}

// --- MASTERCART ADD ---
// Ganti fungsi addToCart lama dengan yang ini
function addToCart(prod, subKey, requestedQty = 1){
    if(!prod || !prod.id){
        showToast("Produk tidak valid");
        return;
    }

    const prodName = prod.name || prod.nama || prod.title || "Produk";
    const status = String(prod.status||"").toLowerCase();
    let stockNum = (prod.stock===0 || prod.stock==="0") ? 0 : (Number(prod.stock)||null);
    const isSold = (status==="sold") || (prod.available===false) || (stockNum===0);

    if(isSold){
        showToast("Produk SOLD / Habis");
        return;
    }

    const exist = State.cart.find(x => x.subKey===subKey && x.id===prod.id);
    const qtyToAdd = Number(requestedQty) || 1;

    if(exist){
        const maxQty = (stockNum == null ? null : Number(stockNum));
        const next = (Number(exist.qty) || 0) + qtyToAdd;
        
        if(maxQty != null && next > maxQty){
            exist.qty = maxQty;
            showToast("Mencapai batas stok");
        } else {
            exist.qty = next;
        }
    } else {
        State.cart.push({
            subKey: subKey,
            id: prod.id,
            name: prodName,
            price: Number(prod.priceNum || prod.price || 0) || 0,
            qty: qtyToAdd,
            stock: stockNum,
            image: prod.image || prod.imageUrl || prod.img || ""
        });
    }

    saveCart();
    updateCartBadge();
    showToast(`${qtyToAdd} item masuk keranjang`);
}

function renderCart(){
  updateCartBadge();
  const items = State.cart;
  if(!items.length){
    UI.cartItems.innerHTML = `<div class="small" style="text-align:center; padding:20px;">Keranjang kosong.</div>`;
    UI.cartTotal.textContent = "Rp 0";
    return;
  }
  
  UI.cartItems.innerHTML = items.map((it, idx)=>`
    <div class="pixel-card product" style="margin-bottom:10px;">
      <div style="display:flex; gap:12px; align-items:center;">
        ${(it.image) ? `<img src="${normalizeImageUrl(it.image)}" style="width:60px; height:60px; border-radius:10px; object-fit:cover; border:1px solid rgba(0,229,255,0.2)">` : ''}
        <div style="flex:1; min-width:0;">
          <div class="name" style="font-size:10px; margin-bottom:4px;">${escapeHtml(it.name)}</div>
          <div class="price" style="font-size:10px;">${fmtRp(it.price)}</div>
        </div>
      </div>
      
      <hr class="sep" style="margin:10px 0; opacity:0.3;">
      
      <div class="row" style="justify-content:space-between; flex-wrap:nowrap;">
        <div class="cart-qty-control">
          <button class="pixel-btn secondary" data-act="dec" data-idx="${idx}" style="padding:4px 8px; min-width:30px;">-</button>
          <input type="number" class="cart-qty-input" data-idx="${idx}" value="${it.qty}" min="1">
          <button class="pixel-btn secondary" data-act="inc" data-idx="${idx}" style="padding:4px 8px; min-width:30px;">+</button>
        </div>
        
        <button class="pixel-btn danger" data-act="del" data-idx="${idx}" style="padding:8px 12px; font-size:9px;">Hapus</button>
      </div>
    </div>
  `).join("");

  UI.cartTotal.textContent = fmtRp(cartSum());

  // Listener untuk tombol (+, -, Hapus)
  $$("#cartItems [data-act]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const idx = Number(b.dataset.idx);
      const act = b.dataset.act;
      const item = State.cart[idx];
      if(!item) return;

      if(act==="inc"){
        const maxQty = (item.stock == null ? 999 : Number(item.stock));
        if(item.qty < maxQty) item.qty++;
        else showToast("Stok maksimal tercapai");
      }
      if(act==="dec"){
        if(item.qty > 1) item.qty--;
      }
      if(act==="del") State.cart.splice(idx,1);
      
      saveCart(); 
      renderCart();
    });
  });

  // Listener untuk Input Qty Manual
  $$(".cart-qty-input").forEach(input => {
    input.addEventListener("change", (e) => {
      const idx = Number(input.dataset.idx);
      const item = State.cart[idx];
      let val = Number(e.target.value);
      const maxQty = (item.stock == null ? 999 : Number(item.stock));

      if (isNaN(val) || val < 1) val = 1;
      if (val > maxQty) {
        val = maxQty;
        showToast("Melebihi stok tersedia");
      }

      item.qty = val;
      saveCart();
      renderCart();
    });
  });
}

UI.btnCart.addEventListener("click", ()=>{ renderCart(); openModal(UI.cartModal); });
UI.btnCloseCart.addEventListener("click", ()=> closeModal(UI.cartModal));
UI.cartModal.addEventListener("click", (e)=>{ if(e.target===UI.cartModal) closeModal(UI.cartModal); });

UI.btnClearCart.addEventListener("click", ()=>{
  State.cart = []; saveCart(); renderCart(); showToast("Keranjang dibersihkan");
});

UI.btnCheckout.addEventListener("click", ()=>{
  if(!State.cart.length){ showToast("Keranjang kosong"); return; }
  
  State.directCheckoutItem = null;
  
  // ‚úÖ RESET FORM SEBELUM BUKA CHECKOUT
  if(UI.coProof) UI.coProof.value = "";
  if(UI.coProofUrl) UI.coProofUrl.value = "";
  if(UI.coProofHint) UI.coProofHint.textContent = "";
  if(UI.proofStatus) UI.proofStatus.textContent = "";
  
  openModal(UI.checkoutModal);
  const u = State.user;
  if(u?.email) UI.coEmail.value = u.email;
  UI.checkoutNote.textContent = "Checkout Keranjang (Login diperlukan).";
  loadPaymentOptions();
});

UI.btnCloseCheckout.addEventListener("click", ()=> closeModal(UI.checkoutModal));
UI.checkoutModal.addEventListener("click", (e)=>{ if(e.target===UI.checkoutModal) closeModal(UI.checkoutModal); });

function requireVerifiedUser(){
  const u = State.user;
  if(!u) return {ok:false, msg:"Silakan login terlebih dahulu"};
  // ‚úÖ GOOGLE USER SELALU VERIFIED
  return {ok:true, user:u};
}

/* ===== DATA LISTENERS (OPTIMIZED) ===== */
function startListeners(){
  // main categories (Realtime)
  if(!Unsub.mainCats){
    Unsub.mainCats = onSnapshot(query(collection(db,"main_categories"), orderBy("order","asc")), (snap)=>{
      const arr=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        if(x.active===false) return;
        arr.push({
          key: (x.key||d.id||"").toLowerCase(),
          label: x.label || x.name || d.id,
          icon: x.icon || "",
          order: Number(x.order||0) || 0,
          active: x.active!==false
        });
      });
      State.mainCats = arr;
      renderLevel();
    }, (err)=>{ console.error(err); });
  }

// ‚úÖ TAMBAHAN BARU: Start listener transaksi terakhir
  startRecentTransactionsListener();
}

  // subcategories (Realtime)
  if(!Unsub.bysSub){
    Unsub.bysSub = onSnapshot(query(collection(db,"bys_subcategories"), orderBy("order","asc")), (snap)=>{
      const arr=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        if(x.active===false) return;
        arr.push({
          id: (x.id||d.id||"").toLowerCase(),
          name: x.name || x.label || d.id,
          icon: x.icon || "",
          order: Number(x.order||0) || 0,
          active: x.active!==false,
          categoryId: (x.categoryId||x.mainKey||"") ? String(x.categoryId||x.mainKey).toLowerCase() : null,
          source:"bys_subcategories"
        });
      });
      State.subCats = arr;
      renderLevel();
    }, (err)=>{ console.error(err); });
  }

  // legacy categories (Realtime)
  if(!Unsub.legacyCats){
    Unsub.legacyCats = onSnapshot(query(collection(db,"categories"), orderBy("order","asc")), (snap)=>{
      const arr=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        if(x.active===false) return;
        const key = (x.key||d.id||"").toLowerCase();
        arr.push({
          key,
          label: x.label || x.name || key,
          icon: x.icon || "",
          order: Number(x.order||0) || 0,
          active: x.active!==false
        });
      });
      State.legacyCats = arr;
      renderLevel();
    }, (err)=>{ console.error(err); });
  }

  // ‚úÖ TIDAK ADA ANNOUNCEMENT DI SINI

// STATIC DATA LOADER (One-Time Fetch - Hemat Kuota)
async function fetchStaticData(){
  try{
    // 1. Ranks
    const snapRanks = await getDocs(query(collection(db,"ranks"), orderBy("pos","asc"), limit(20)));
    const arrRanks = [];
    snapRanks.forEach(d=>{
      const x=d.data()||{};
      arrRanks.push({ name:x.name||"-", total:x.total||0, pos:x.pos||999, prize:x.prize||"" });
    });
    State.ranks = arrRanks;
    renderRanks(arrRanks);

    // 2. About
    const snapAbout = await getDocs(query(collection(db,"about"), orderBy("order","asc")));
    const itemsAbout = [];
    snapAbout.forEach(d=>{
      const x=d.data()||{};
      if(x.active===false) return;
      itemsAbout.push({
        id:d.id, title: x.title||x.label||d.id,
        sub: x.sub||x.subtitle||"",
        icon: x.icon||"",
        url: x.url||x.link||""
      });
    });
    State.aboutItems = itemsAbout;
    State.socialLinks = (itemsAbout||[]).filter(it=> (it.url||"").trim());
    renderContacts(itemsAbout);

    // 3. WA Admins
    const snapWa = await getDocs(query(collection(db,"wa_admins"), orderBy("order","asc")));
    const arrWa = [];
    snapWa.forEach(d=>{
      const x=d.data()||{};
      const num = String(x.number||x.wa||"").replace(/[^0-9]/g,"");
      if(!num) return;
      arrWa.push({ number:num, label:x.label||"Admin" });
    });
    State.waAdmins = arrWa;

    // 4. Payment Methods
    const snapPays = await getDocs(query(collection(db,"paymentMethods"), orderBy("order","asc")));
    const arrPays = [];
    snapPays.forEach(d=>{
      const x=d.data()||{};
      if(x.active===false) return;
      arrPays.push({
        id:d.id,
        label: x.label || x.name || d.id,
        type: x.type || "other",
        account: x.account || x.no || x.number || "",
        holder: x.holder || x.atasNama || "",
        order: Number(x.order||0)||0,
        active: x.active!==false,
        qrisUrl: x.qrisUrl || x.qris || x.imageUrl || ""
      });
    });
    State.paymentMethods = arrPays;
    loadPaymentOptions();

  }catch(e){
    console.error("Static data fetch error:", e);
  }
}

function stopListeners(){
  Object.keys(Unsub).forEach(k=>{
    const fn = Unsub[k];
    if(typeof fn==="function"){ try{ fn(); }catch(e){} }
    Unsub[k]=null;
  });
  
  if(recentTxUnsub){ try{recentTxUnsub();}catch(e){} recentTxUnsub=null; }
  
  // ‚úÖ TAMBAHKAN INI (Stop interval auto-refresh)
  if(recentTxInterval){ clearInterval(recentTxInterval); recentTxInterval=null; }
}

// ‚úÖ TAMBAHKAN INI
  if(txAutoplayInterval){ clearInterval(txAutoplayInterval); txAutoplayInterval=null; }

/* ===== CONTACTS RENDER ===== */
function renderContacts(items){
  if(!items || !items.length){
    UI.drawerContacts.innerHTML = `<div class="small">Belum ada data kontak.</div>`;
    return;
  }
  UI.drawerContacts.innerHTML = items.map(it=>{
    let rawImg = it.image || it.imageUrl || it.img || it.iconUrl || "";
    if(!rawImg && it.icon && (it.icon.includes("/") || it.icon.includes("http") || it.icon.includes("pixhost"))){
        rawImg = it.icon;
    }
    const nimg = normalizeImageUrl(rawImg);
    const iconHtml = nimg
      ? `<img class="mini-img" src="${escapeHtml(nimg)}" alt="" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">`
      : `<div class="ico">${escapeHtml(it.icon&&!it.icon.includes('/')?it.icon:"üîó")}</div>`;
    return `
      <a class="pixel-card item" style="padding:12px" href="${escapeHtml(it.url||"#")}" target="_blank" rel="noopener">
        ${iconHtml}
        <div class="txt">
          <div class="t">${escapeHtml(it.title)}</div>
          <div class="d">${escapeHtml(it.sub)}</div>
        </div>
        <div class="tile-chev">‚Ä∫</div>
      </a>
    `;
  }).join("");
}

/* ===== RANKING ===== */
function renderRanks(arr){
  if(!UI.rankList) return;
  if(!arr || !arr.length){
    UI.rankList.innerHTML = `<div class="small">Belum ada data peringkat.</div>`;
    return;
  }
  UI.rankList.innerHTML = arr.map((r,i)=>`
    <div class="pixel-card product">
      <div class="row" style="justify-content:space-between">
        <div class="name">#${i+1} ${escapeHtml(r.name)}</div>
        <div class="price">${escapeHtml(fmtRp(r.total))}</div>
      </div>
      <div class="meta">${escapeHtml(r.prize||"")}</div>
    </div>
  `).join("");
}
UI.btnOpenRanking.addEventListener("click", ()=>{ openModal(UI.rankModal); });
UI.btnCloseRank.addEventListener("click", ()=> closeModal(UI.rankModal));
UI.rankModal.addEventListener("click", (e)=>{ if(e.target===UI.rankModal) closeModal(UI.rankModal); });

function toggleContactsPanel(){
  const p = $("#contactsPanel");
  if(!p) return;
  const open = p.style.display !== "none";
  p.style.display = open ? "none" : "block";
}
bindOnce(UI.btnOpenContacts, "contacts", "click", (e)=>{ e.preventDefault(); toggleContactsPanel(); });

/* ===== UI HELPERS: DROPDOWN & ZOOM & SOSMED PICKER ===== */
function closeAllDropdowns(){
  $$(".dd-menu.show").forEach(m=>m.classList.remove("show"));
}

/* ===== GET PRODUCT BY ID (ANY SUBCATEGORY) ===== */
function getProductByIdAny(pid){
  if(!pid) return null;
  
  // Cari di subcategory yang sedang aktif
  const subKey = State.pickedSub;
  if(subKey){
    const currentList = (State.productsCache.get(subKey) || []);
    let p = currentList.find(x=> String(x.id||x.key||"")===String(pid));
    if(p) return p;
  }
  
  // Jika tidak ketemu, cari di semua subcategories yang sudah di-cache
  for (const [key, products] of State.productsCache.entries()) {
    const found = products.find(x=> String(x.id||x.key||"")===String(pid));
    if(found) {
      State.pickedSub = key; // Set subcategory yang aktif
      return found;
    }
  }
  
  return null;
}

// GANTI FUNGSI doCheckoutWebById DENGAN INI:

function doCheckoutWebById(pid){
  const prod = getProductByIdAny(pid);
  if(!prod){ showToast("Produk tidak ditemukan"); return; }
  
  // ‚úÖ RESET FORM SEBELUM BUKA CHECKOUT
  if(UI.coProof) UI.coProof.value = "";
  if(UI.coProofUrl) UI.coProofUrl.value = "";
  if(UI.coProofHint) UI.coProofHint.textContent = "";
  if(UI.proofStatus) UI.proofStatus.textContent = "";
  
  // Validasi stok & status
  const status = String(prod.status||"").toLowerCase();
  let stockNum = (prod.stock===0 || prod.stock==="0") ? 0 : (Number(prod.stock)||null);
  const isSold = (status==="sold") || (prod.available===false) || (stockNum===0);
  if(isSold){ showToast("Produk SOLD / Habis"); return; }
  
  State.directCheckoutItem = {
      subKey: State.pickedSub || "direct",
      id: prod.id,
      name: prod.name || prod.nama || "Produk",
      price: Number(prod.priceNum || prod.price || 0) || 0,
      qty: 1,
      stock: stockNum,
      image: prod.image || prod.imageUrl || ""
  };

  openModal(UI.checkoutModal);
  const u = State.user;
  if(u?.email) UI.coEmail.value = u.email;
  
  // --- MODIFIKASI HTML UNTUK TOMBOL +/- ---
  const qtyEditHtml = `
    <div style="margin:12px 0; padding:12px; background:rgba(0,255,156,0.05); border:2px solid rgba(0,255,156,0.3); border-radius:12px;">
      <div style="font-size:11px; color:var(--neon); margin-bottom:8px;">üì¶ <strong>Item yang akan dibeli:</strong></div>
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
        ${prod.image ? `<img src="${escapeHtml(normalizeImageUrl(prod.image))}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">` : ''}
        <div style="flex:1;">
          <div style="font-size:12px; color:var(--text); font-weight:bold;">${escapeHtml(prod.name)}</div>
          <div style="font-size:10px; color:var(--muted);">${escapeHtml(fmtRp(prod.priceNum||prod.price||0))}</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label style="font-size:10px; color:var(--muted);">Jumlah:</label>
        <div style="display:flex; align-items:center; gap:5px;">
          <button id="btnMinusDirect" class="pixel-btn secondary" style="padding:4px 10px; font-size:12px; min-width:30px;">-</button>
          
          <input type="number" id="directQtyInput" min="1" ${stockNum ? `max="${stockNum}"` : ''} value="1" 
               style="width:60px; text-align:center; padding:6px; background:rgba(0,0,0,0.3); border:1px solid rgba(0,255,156,0.5); border-radius:6px; color:var(--text); font-size:11px;">
          
          <button id="btnPlusDirect" class="pixel-btn secondary" style="padding:4px 10px; font-size:12px; min-width:30px;">+</button>
        </div>
        ${stockNum ? `<span style="font-size:9px; color:var(--muted);">(Stok: ${stockNum})</span>` : ''}
      </div>
      <div id="directTotalPreview" style="margin-top:8px; font-size:11px; color:var(--yellow);">Total: <strong>${fmtRp(prod.priceNum||prod.price||0)}</strong></div>
    </div>
  `;
  
  if(UI.checkoutNote) {
      UI.checkoutNote.innerHTML = `<div style="font-size:11px; color:var(--cyan); margin-bottom:8px;">Checkout Langsung</div>${qtyEditHtml}`;
      
      // --- LOGIKA TOMBOL +/- ---
      setTimeout(() => {
        const qtyInput = document.getElementById('directQtyInput');
        const totalPreview = document.getElementById('directTotalPreview');
        const btnMinus = document.getElementById('btnMinusDirect');
        const btnPlus = document.getElementById('btnPlusDirect');

        const updateData = () => {
          let val = Number(qtyInput.value) || 1;
          if(stockNum && val > stockNum) val = stockNum;
          if(val < 1) val = 1;
          qtyInput.value = val;
          State.directCheckoutItem.qty = val;
          totalPreview.innerHTML = `Total: <strong>${fmtRp((prod.priceNum||prod.price||0) * val)}</strong>`;
        };

        // Event Input Manual
        qtyInput.addEventListener('input', updateData);

        // Event Tombol Minus
        btnMinus.onclick = () => {
          qtyInput.value = Math.max(1, (Number(qtyInput.value) || 1) - 1);
          updateData();
        };

        // Event Tombol Plus
        btnPlus.onclick = () => {
          let current = Number(qtyInput.value) || 1;
          if(!stockNum || current < stockNum) {
            qtyInput.value = current + 1;
            updateData();
          } else {
            showToast("Stok tidak mencukupi");
          }
        };
      }, 100);
  }
  
  loadPaymentOptions();
}

/* ===== ZOOM IMAGE MODAL ===== */
function openZoom(imageUrl, productData = null){
  if(!imageUrl){ showToast("Gambar tidak tersedia"); return; }
  
  const modal = UI.zoomModal || $("#zoomModal");
  const img = UI.zoomImg || $("#zoomImg");
  
  if(!modal || !img) return;
  
  const normalized = normalizeImageUrl(imageUrl);
  img.src = normalized;
  img.alt = "Preview Gambar";
  
  // Error handler jika gambar gagal load
  img.onerror = ()=>{
    showToast("Gambar gagal dimuat");
    closeZoom();
  };
  
  // ‚úÖ TAMBAHKAN DESKRIPSI PRODUK
  let descContainer = document.getElementById('zoomProductDesc');
  if(!descContainer){
    descContainer = document.createElement('div');
    descContainer.id = 'zoomProductDesc';
    descContainer.style.cssText = 'margin-top:15px; padding:12px; background:rgba(0,255,156,0.05); border:2px solid rgba(0,255,156,0.2); border-radius:12px; max-height:150px; overflow-y:auto;';
    
    const zoomWrap = modal.querySelector('.zoom-wrap');
    if(zoomWrap){
      zoomWrap.parentNode.insertBefore(descContainer, zoomWrap.nextSibling);
    }
  }
  
  if(productData && productData.desc){
    descContainer.innerHTML = `
      <div style="font-size:10px; color:var(--neon); font-weight:bold; margin-bottom:8px;">üìù Deskripsi Produk:</div>
      <div style="font-size:11px; color:var(--text); line-height:1.6; white-space:pre-wrap;">${escapeHtml(productData.desc)}</div>
    `;
    descContainer.style.display = 'block';
  } else {
    descContainer.style.display = 'none';
  }
  
  openModal(modal);
}

function closeZoom(){
  const modal = UI.zoomModal || $("#zoomModal");
  if(modal) closeModal(modal);
}

// Bind zoom modal close button
if(UI.btnCloseZoom){
  bindOnce(UI.btnCloseZoom, "closeZoom", "click", closeZoom);
}

// Close zoom saat klik backdrop
if(UI.zoomModal){
  UI.zoomModal.addEventListener("click", (e)=>{
    if(e.target === UI.zoomModal) closeZoom();
  });
}

/* ===== CATALOG: HYBRID NAV ===== */
function resetCatalog(){
  State.level = "category";
  State.pickedMain = null;
  State.pickedSub = null;
  renderLevel();
}

function buildHybridCategoryList(){
  const main = (State.mainCats||[]).slice().sort((a,b)=> (a.order||0)-(b.order||0));
  if(main.length){
    return main.map(x=>({ key:x.key, label:x.label, icon:x.icon, source:"main_categories" }));
  }
  const leg = (State.legacyCats||[]).slice().sort((a,b)=> (a.order||0)-(b.order||0));
  return leg.map(x=>({ key:x.key, label:x.label, icon:x.icon, source:"categories" }));
}

function buildSubCategoryListForMain(mainKey){
  const out=[];
  const mapped = (State.subCats||[]).filter(s=> (s.categoryId||null) === (mainKey||null));
  mapped.sort((a,b)=> (a.order||0)-(b.order||0));
  mapped.forEach(s=> out.push({ subKey:(s.subKey||s.key||s.id), name:s.name, icon:s.icon, source:s.source, categoryId:s.categoryId }));
  return out;
}

function buildLegacySubList(){
  const mappedIds = new Set((State.subCats||[]).map(s=>s.id));
  const leg = (State.legacyCats||[]).slice().sort((a,b)=> (a.order||0)-(b.order||0));
  return leg.map(x=>({ subKey:x.key, name:x.label, icon:x.icon, source:"categories", categoryId:null }));
}

function applySearch(list, fields){
  const q = (State.search||"").trim().toLowerCase();
  if(!q) return list;
  return list.filter(it=>{
    return fields.some(f=> safeStr(it[f]).toLowerCase().includes(q));
  });
}

function renderBreadcrumb(){
  const crumbs=[];
  const add = (label, active, onClick)=>{
    crumbs.push({label, active, onClick});
  };
  add("Produk", State.level==="category", ()=>{ State.level="category"; State.pickedMain=null; State.pickedSub=null; renderLevel(); });
  if(State.level!=="category" && State.pickedMain){
    const mainLabel = (State.mainCats.find(c=>c.key===State.pickedMain)?.label) || State.pickedMain;
    add(mainLabel, State.level==="sub", ()=>{ State.level="sub"; State.pickedSub=null; renderLevel(); });
  }
  if(State.level==="product" && State.pickedSub){
    add(State.pickedSub, true, ()=>{});
  }
  UI.breadcrumb.innerHTML = crumbs.map((c,i)=>`
    <button class="crumb ${c.active?"active":""}" data-i="${i}">${escapeHtml(c.label)}</button>
  `).join("");
  $$("#breadcrumb .crumb").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.dataset.i);
      const c = crumbs[i];
      if(c && typeof c.onClick==="function") c.onClick();
    });
  });
}

function renderLevel(){
  if(!UI.levelWrap) return;
  renderBreadcrumb();

  const sortMode = UI.sortSelect?.value || "popular";

  if(State.level==="category"){
    UI.levelWrap.className = "grid-menu"; 

    const cats = buildHybridCategoryList();
    const hasMain = (State.mainCats||[]).length>0;
    const list = hasMain ? cats.concat([{key:"__legacy__", label:"LAINNYA (Legacy)", icon:"", source:"legacy"}]) : cats;
    const filtered = applySearch(list, ["label","key"]);

    UI.levelWrap.innerHTML = filtered.map(c=>{
      // ‚úÖ HITUNG HARGA TERENDAH & TOTAL TERJUAL
      let minPrice = null;
      let soldCount = 0;
      
      // Cari semua sub dari kategori ini
      const subsInCat = (State.subCats||[]).filter(s => s.categoryId === c.key);
      
      subsInCat.forEach(sub => {
        const products = State.productsCache.get(sub.id) || [];
        products.forEach(prod => {
          const price = prod.priceNum || 0;
          if(!minPrice || price < minPrice) minPrice = price;
        });
      });
      
      // Hitung total sold dari orders (status success)
      const orders = State.ordersRows || [];
      orders.forEach(order => {
        if(String(order.status||"").toLowerCase() === "success"){
          (order.items || []).forEach(item => {
            subsInCat.forEach(sub => {
              if(item.subKey === sub.id) soldCount++;
            });
          });
        }
      });

      return `
        <div class="pixel-card cat-card">
          ${soldCount > 0 ? `<div class="cat-sold-badge">${soldCount} Terjual</div>` : ''}
          ${c.key !== "__legacy__" ? `<button class="share-btn" data-share-type="category" data-main-key="${escapeHtml(c.key)}" title="Bagikan kategori">üîó</button>` : ''}
          
          <div data-main="${escapeHtml(c.key)}" style="cursor:pointer; width:100%;">
            ${c.icon 
              ? `<div class="cat-img-area"><img src="${escapeHtml(c.icon)}" alt="${escapeHtml(c.label)}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=cat-placeholder>üìÅ</div>';"></div>` 
              : `<div class="cat-placeholder">üìÅ</div>`
            }
            
            <div class="cat-info">
              <div class="cat-title">${escapeHtml(c.label)}</div>
              
              ${minPrice ? `
                <div class="cat-price-info">
                  <div class="cat-price-label">Mulai dari</div>
                  <div class="cat-price">${fmtRp(minPrice)}</div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }).join("") || `<div class="small" style="grid-column:1/-1; text-align:center">Tidak ada kategori.</div>`;

    // Event klik kategori
    $$("#levelWrap [data-main]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const key = el.getAttribute("data-main");
        if(key==="__legacy__"){
          State.level="sub";
          State.pickedMain="__legacy__";
          State.pickedSub=null;
          renderLevel();
          return;
        }
        State.level="sub";
        State.pickedMain = key;
        State.pickedSub = null;
        location.hash = `#category/${encodeURIComponent(key)}`;
        renderLevel();
      });
    });

    // Event share button
    $$("#levelWrap .share-btn").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const mainKey = btn.getAttribute("data-main-key");
        copyProductLink('category', { mainKey });
      });
    });
    return;
  }

  if(State.level==="sub"){
    UI.levelWrap.className = "grid-menu"; 
    const mainKey = State.pickedMain;
    let subs = [];
    if(mainKey && mainKey!=="__legacy__"){
      subs = buildSubCategoryListForMain(mainKey);
      if(!subs.length) subs = buildLegacySubList();
    }else{
      subs = buildLegacySubList();
    }
    const filtered = applySearch(subs, ["name","subKey"]);

    UI.levelWrap.innerHTML = filtered.map(s=>{
      // ‚úÖ HITUNG HARGA TERENDAH & TOTAL TERJUAL PER SUB
      let minPrice = null;
      let soldCount = 0;
      
      const products = State.productsCache.get(s.subKey) || [];
      products.forEach(prod => {
        const price = prod.priceNum || 0;
        if(!minPrice || price < minPrice) minPrice = price;
      });
      
      // Hitung sold dari orders success
      const orders = State.ordersRows || [];
      orders.forEach(order => {
        if(String(order.status||"").toLowerCase() === "success"){
          (order.items || []).forEach(item => {
            if(item.subKey === s.subKey) soldCount++;
          });
        }
      });

      return `
        <div class="pixel-card cat-card">
          ${soldCount > 0 ? `<div class="cat-sold-badge">${soldCount} Terjual</div>` : ''}
          <button class="share-btn" data-share-type="subcategory" data-main-key="${escapeHtml(State.pickedMain)}" data-sub-key="${escapeHtml(s.subKey)}" title="Bagikan sub-kategori">üîó</button>
          
          <div data-sub="${escapeHtml(s.subKey)}" style="cursor:pointer; width:100%;">
            ${s.icon 
              ? `<div class="cat-img-area"><img src="${escapeHtml(s.icon)}" alt="${escapeHtml(s.name)}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=cat-placeholder>üóÇÔ∏è</div>';"></div>` 
              : `<div class="cat-placeholder">üóÇÔ∏è</div>`
            }
            
            <div class="cat-info">
              <div class="cat-title">${escapeHtml(s.name)}</div>
              
              ${minPrice ? `
                <div class="cat-price-info">
                  <div class="cat-price-label">Mulai dari</div>
                  <div class="cat-price">${fmtRp(minPrice)}</div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }).join("") || `<div class="small" style="grid-column:1/-1; text-align:center">Tidak ada sub kategori.</div>`;

    // Event klik sub
    $$("#levelWrap [data-sub]").forEach(el=>{
      el.addEventListener("click", async ()=>{
        State.level="product";
        State.pickedSub = el.getAttribute("data-sub");
        location.hash = `#category/${encodeURIComponent(State.pickedMain)}/sub/${encodeURIComponent(State.pickedSub)}`;
        await ensureProductsLoaded(State.pickedSub);
        renderLevel();
      });
    });

    // Event share button
    $$("#levelWrap .share-btn").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const mainKey = btn.getAttribute("data-main-key");
        const subKey = btn.getAttribute("data-sub-key");
        copyProductLink('subcategory', { mainKey, subKey });
      });
    });
    return;
  }

  if(State.level==="product"){
    UI.levelWrap.className = "grid-menu"; 
    const subKey = State.pickedSub;
    const list = (State.productsCache.get(subKey) || []).slice();

    const sorter = {
      price_asc: (a,b)=> priceNumOf(a)-priceNumOf(b),
      price_desc: (a,b)=> priceNumOf(b)-priceNumOf(a),
      name_asc: (a,b)=> (a.name||"").localeCompare(b.name||""),
      name_desc: (a,b)=> (b.name||"").localeCompare(a.name||""),
      popular: (a,b)=> ((b.soldCount||b.sold||b.paidCount||0)-(a.soldCount||a.sold||a.paidCount||0)) || ((b.order||0)-(a.order||0))
    }[sortMode] || ((a,b)=>0);
    list.sort(sorter);

    const filtered = applySearch(list, ["name","price","stock","status","category"]);

    UI.levelWrap.innerHTML = filtered.map(prod=>{
  const status = String(prod.status||"").toLowerCase();
  const stockNum = (prod.stock===0 || prod.stock==="0") ? 0 : (Number(prod.stock)||null);
  const isSold = (status==="sold") || (prod.available===false) || (stockNum===0) || (String(prod.stock||"").toLowerCase()==="sold");
  const img = prod.image || prod.imageUrl || prod.img || prod.icon || "";
  const stockLabel = (stockNum===0) ? "0" : (stockNum ? `${stockNum}` : (prod.stock ? String(prod.stock) : "?"));

  return `
    <div class="prod-grid-card" data-product-id="${escapeHtml(prod.id)}">
      <button class="share-btn prod-share" data-share-type="product" data-sub-key="${escapeHtml(subKey)}" data-product-id="${escapeHtml(prod.id)}" title="Bagikan produk">üîó</button>
      <div class="img-area" data-zoom="${escapeHtml(img)}">
         ${img ? `<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Crect fill='%230b1220' width='400' height='400'/%3E%3C/svg%3E" data-src="${escapeHtml(normalizeImageUrl(img))}" alt="img" loading="lazy" class="lazy-img">` : ``}
      </div>
          <div class="info">
            <div class="p-title">${escapeHtml(prod.name||"-")}</div>
            <div class="p-price">
  ${prod.hasDiscount ? `<span class="original-price">${escapeHtml(fmtRp(prod.originalPrice))}</span>` : ''}
  ${escapeHtml(fmtRp(prod.priceNum))}
  ${prod.hasDiscount ? `<span class="discount-badge">-${prod.discountPercent}%</span>` : ''}
</div>
            <div style="display:flex; justify-content:space-between; align-items:center">
               <div class="status-badge ${isSold?'sold':'ready'}">${isSold?'SOLD':'READY'}</div>
               <div class="small" style="font-size:9px; opacity:0.7">Stok: ${stockLabel}</div>
            </div>
            <div class="actions" style="margin-top:10px;">
              <div style="display:flex; align-items:center; gap:5px; margin-bottom:8px;">
                 <button class="pixel-btn secondary qty-minus" data-id="${escapeHtml(prod.id)}" data-stock="${stockNum||''}" style="padding:4px 8px; flex:1;" ${isSold?"disabled":""}>-</button>
                 <input type="number" class="qty-input" data-id="${escapeHtml(prod.id)}" data-stock="${stockNum||''}" value="1" min="1" ${stockNum ? `max="${stockNum}"` : ''} 
                        style="width:50px; text-align:center; background:rgba(0,0,0,0.3); border:1px solid rgba(0,255,156,0.3); border-radius:6px; color:var(--text); font-size:10px; padding:6px 0;" ${isSold?"disabled":""}>
                 <button class="pixel-btn secondary qty-plus" data-id="${escapeHtml(prod.id)}" data-stock="${stockNum||''}" style="padding:4px 8px; flex:1;" ${isSold?"disabled":""}>+</button>
              </div>
              <button class="pixel-btn btn-act ${isSold?"secondary":"yellow"}" data-add="${escapeHtml(prod.id)}" ${isSold?"disabled":""}>
                 ${isSold ? "Habis" : "Tambah"}
              </button>
              <button class="pixel-btn secondary btn-act" data-checkout="${escapeHtml(prod.id)}" ${isSold?"disabled":""}>
                 Checkout
              </button>
            </div>
          </div>
        </div>`;
    }).join("") || `<div class="small" style="grid-column:1/-1; text-align:center">Produk belum tersedia.</div>`;

    // Event listener untuk checkout - LANGSUNG KE WEB CHECKOUT
$$("#levelWrap [data-checkout]").forEach(btn=>{
  btn.addEventListener("click",(e)=>{
    e.stopPropagation();
    const pid = btn.getAttribute("data-checkout");
    doCheckoutWebById(pid);
  });
});

    // Event listener untuk zoom gambar
$$("#levelWrap [data-zoom]").forEach(imgEl=>{
  imgEl.addEventListener("click", ()=>{
    const src = imgEl.getAttribute("data-zoom");
    const prodId = imgEl.closest('[data-product-id]')?.getAttribute('data-product-id');
    
    let productData = null;
    if(prodId && State.pickedSub){
      productData = (State.productsCache.get(State.pickedSub) || []).find(x => x.id === prodId);
    }
    
    if(src) openZoom(src, productData);
  });
});
    
    // Event share produk
    $$("#levelWrap .prod-share").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const subKey = btn.getAttribute("data-sub-key");
        const productId = btn.getAttribute("data-product-id");
        copyProductLink('product', { subKey, productId });
      });
    });

    // Tombol Minus
    $$("#levelWrap .qty-minus").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const pid = btn.getAttribute("data-id");
        const input = $(`.qty-input[data-id="${pid}"]`);
        if(input) {
          let val = Number(input.value) || 1;
          input.value = Math.max(1, val - 1);
        }
      });
    });

    // Tombol Plus
    $$("#levelWrap .qty-plus").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const pid = btn.getAttribute("data-id");
        const stockNum = btn.getAttribute("data-stock");
        const maxStock = stockNum ? Number(stockNum) : null;
        const input = $(`.qty-input[data-id="${pid}"]`);
        if(input) {
          let val = Number(input.value) || 1;
          if(maxStock && val >= maxStock) {
            showToast("Stok tidak cukup");
          } else {
            input.value = val + 1;
          }
        }
      });
    });

    // Validasi input manual
    $$("#levelWrap .qty-input").forEach(input=>{
      input.addEventListener("input", ()=>{
        const stockNum = input.getAttribute("data-stock");
        const maxStock = stockNum ? Number(stockNum) : null;
        let val = Number(input.value) || 1;
        if(val < 1) val = 1;
        if(maxStock && val > maxStock) val = maxStock;
        input.value = val;
      });
    });

    // Tombol Tambah ke Keranjang
    $$("#levelWrap [data-add]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = btn.getAttribute("data-add");
        const prod = (State.productsCache.get(subKey)||[]).find(x=>x.id===pid);
        if(!prod) return;
        const input = $(`.qty-input[data-id="${pid}"]`);
        const qty = input ? (Number(input.value) || 1) : 1;
        addToCart(prod, subKey, qty);
      });
    });

    // ‚úÖ INIT LAZY LOADING SETELAH RENDER
    setTimeout(() => initLazyImages(), 100);

    return;
  }
}

/* ===== LAZY LOADING IMAGES ===== */
let lazyImageObserver = null;

function initLazyImages() {
  if (lazyImageObserver) {
    lazyImageObserver.disconnect();
  }

  const lazyImages = document.querySelectorAll('.lazy-img');
  if (!lazyImages.length) return;

  if ('IntersectionObserver' in window) {
    lazyImageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          const src = img.getAttribute('data-src');
          
          if (src && !img.classList.contains('loaded')) {
            img.src = src;
            img.classList.add('loaded');
            img.onerror = () => { img.style.display = 'none'; };
            observer.unobserve(img);
          }
        }
      });
    }, {
      rootMargin: '50px 0px',
      threshold: 0.01
    });

    lazyImages.forEach(img => lazyImageObserver.observe(img));
  } else {
    lazyImages.forEach(img => {
      const src = img.getAttribute('data-src');
      if (src) img.src = src;
    });
  }
}

// OPTIMIZED: Debounced Search Listener
UI.searchInput.addEventListener("input", debounce((e)=>{
  State.search = e.target.value || "";
  renderLevel();
}, 300));

UI.sortSelect.addEventListener("change", ()=>{ renderLevel(); });

/* ===== PRODUCTS LOADING ===== */
async function ensureProductsLoaded(subKey){
  if(!subKey) return;
  if(State.productsCache.has(subKey)) return;
  showLoader("Memuat produk...");
  try{
    const snap = await getDocs(query(collection(db, subKey)));
    const arr = snap.docs.map(d=>{
      const x=d.data()||{};
      let priceNum = Number(String(x.price||x.harga||0).replace(/[^0-9]/g,"")) || 0;
      
      // ‚úÖ HITUNG DISKON JIKA AKTIF
      let finalPrice = priceNum;
      let hasDiscount = false;
      
      if(x.discountPercent && x.discountPercent > 0){
        const now = new Date();
        const startDate = x.discountStartAt ? (x.discountStartAt.toDate ? x.discountStartAt.toDate() : new Date(x.discountStartAt)) : null;
        const endDate = x.discountEndAt ? (x.discountEndAt.toDate ? x.discountEndAt.toDate() : new Date(x.discountEndAt)) : null;
        
        const isActive = (!startDate || now >= startDate) && (!endDate || now <= endDate);
        
        if(isActive){
          const discount = priceNum * (x.discountPercent / 100);
          finalPrice = Math.round(priceNum - discount);
          hasDiscount = true;
        }
      }
      
      return {
        id:d.id,
        name: x.name || x.title || x.nama || d.id,
        price: x.price || x.harga || priceNum,
        priceNum: finalPrice, // ‚úÖ HARGA SETELAH DISKON
        originalPrice: priceNum, // ‚úÖ SIMPAN HARGA ASLI
        discountPercent: hasDiscount ? x.discountPercent : 0,
        hasDiscount: hasDiscount,
        stock: x.stock ?? x.stok ?? "",
        status: x.status || (x.available===false ? "sold" : ""),
        available: x.available !== false,
        desc: x.description || x.desc || "",
        image: x.image || x.imageUrl || x.img || x.icon || "",
        order: Number(x.order||0) || 0
      };
    });
    State.productsCache.set(subKey, arr);
  }catch(e){
    console.error(e);
    State.productsCache.set(subKey, []);
    showToast("Gagal memuat produk: " + (e?.message||e?.code||"error"));
  }finally{ hideLoader(); }
}

/* ===== PAYMENT OPTIONS ===== */
function loadPaymentOptions(){
  const opts = (State.paymentMethods||[]).filter(x=>x.active!==false);
  if(!UI.coPayMethod) return;
  UI.coPayMethod.innerHTML = "";
  if(!opts.length){
    const o=document.createElement("option");
    o.value=""; o.textContent="Metode pembayaran belum tersedia";
    UI.coPayMethod.appendChild(o);
    renderPayDetail(null);
    return;
  }
  const o0=document.createElement("option");
  o0.value=""; o0.textContent="Pilih metode pembayaran";
  UI.coPayMethod.appendChild(o0);
  opts.forEach(p=>{
    const o=document.createElement("option");
    o.value = p.id;
    o.textContent = p.label + (p.type==="qris" ? " (QRIS)" : "");
    UI.coPayMethod.appendChild(o);
  });
  renderPayDetail(opts[0]||null);
}

function renderPayDetail(method){
  const box = $("#payDetail");
  const txt = $("#payDetailText");
  const act = $("#payDetailActions");
  const img = $("#payDetailQris");
  if(!box || !txt || !act || !img) return;

  if(!method){
    box.style.display="none";
    txt.textContent="";
    act.innerHTML="";
    img.style.display="none";
    return;
  }
  box.style.display="block";
  act.innerHTML="";
  img.style.display="none";

  const lines = [];
  lines.push(`<div><b>Metode</b>: ${escapeHtml(method.label||method.id)}</div>`);

  const acc = safeStr(method.account).trim();
  const holder = safeStr(method.holder).trim();
  if(method.type==="qris" && method.qrisUrl){
    lines.push(`<div style="margin-top:8px">Silakan scan QRIS di bawah ini.</div>`);
    img.src = method.qrisUrl;
    img.style.display="block";
    const btnCopy = document.createElement("button");
    btnCopy.className="pixel-btn secondary";
    btnCopy.textContent="Salin Link QRIS";
    btnCopy.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(method.qrisUrl); showToast("Link QRIS disalin"); }
      catch(e){ showToast("Gagal salin"); }
    });
    act.appendChild(btnCopy);
  }else{
    if(acc) lines.push(`<div style="margin-top:8px"><b>No/ID</b>: <span style="color:var(--neon)">${escapeHtml(acc)}</span></div>`);
    if(holder) lines.push(`<div style="margin-top:6px"><b>Atas Nama</b>: ${escapeHtml(holder)}</div>`);
    if(acc){
      const btn = document.createElement("button");
      btn.className="pixel-btn secondary";
      btn.textContent="Salin Nomor";
      btn.addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText(acc); showToast("Nomor disalin"); }
        catch(e){ showToast("Gagal salin"); }
      });
      act.appendChild(btn);
    }
  }

  txt.innerHTML = lines.join("");
}

bindOnce(UI.coPayMethod, "paySelect", "change", ()=>{
  const id = safeStr(UI.coPayMethod.value);
  const m = (State.paymentMethods||[]).find(x=>x.id===id);
  renderPayDetail(m||null);
});

/* ===== TRANSAKSI: REALTIME LISTENER & DETAIL VIEW ===== */

// Fungsi Helper untuk merender tanggal
function formatTimestamp(ts){
  if(!ts) return "-";
  const d = ts.toDate ? ts.toDate() : (ts.seconds ? new Date(ts.seconds*1000) : new Date(ts));
  return d.toLocaleString("id-ID",{dateStyle:"short", timeStyle:"short"});
}

// Listener Transaksi (Update dari Admin)
function startOrdersListener(){
  // Matikan lama jika ada
  if(Unsub.orders){ try{Unsub.orders();}catch(e){} Unsub.orders=null; }

  const u = State.user;
  
  // Cek Login
  if(!u){ 
    UI.txList.innerHTML = `<div class="small" style="text-align:center; padding:20px; color:var(--muted);">Login untuk melihat riwayat transaksi Anda.</div>`; 
    return; 
  }

  // Tampilkan Loading sementara
  UI.txList.innerHTML = `<div class="small" style="text-align:center; padding:20px;">Memuat data...</div>`;

  try {
    // Query: Ambil Orders dimana 'uid' == User ID login, urutkan dari terbaru
    const q = query(
      collection(db, "orders"), 
      where("uid", "==", u.uid), 
      orderBy("createdAt", "desc"), 
      limit(20)
    );

    // Pasang Realtime Listener
    Unsub.orders = onSnapshot(q, (snap)=>{
      const rows = [];
      snap.forEach(d => rows.push({ id:d.id, ...d.data() }));
      
      State.ordersRows = rows;
      renderTransactions(rows); // Render ke layar
      
      if(rows.length === 0) {
         UI.txList.innerHTML = `<div class="small" style="text-align:center; padding:20px; color:var(--muted);">Belum ada transaksi.</div>`;
      }
    }, (err)=>{
      console.error("Error memuat order:", err);
      // Jika error karena index belum dibuat
      if(err.message.includes("indexes")) {
        UI.txList.innerHTML = `<div class="small" style="color:var(--danger); padding:10px;">Admin perlu membuat Index Database (Cek Console).</div>`;
      } else {
        UI.txList.innerHTML = `<div class="small" style="color:var(--danger); padding:10px;">Gagal memuat: ${err.code || err.message}</div>`;
      }
    });

  } catch(e){
    console.error("Setup listener error:", e);
  }
}

// GANTI SELURUH FUNGSI renderTransactions DENGAN INI:
function renderTransactions(rows){
  if(!UI.txList) return;
  if(!State.user){ UI.txList.innerHTML = `<div class="small">Login untuk melihat transaksi.</div>`; return; }
  const arr = Array.isArray(rows) ? rows : [];
  if(!arr.length){
    UI.txList.innerHTML = `<div class="small">Belum ada transaksi.</div>`;
    return;
  }
  
  UI.txList.innerHTML = arr.map(o => { 
    const st = String(o.status||"pending").toLowerCase();
    
    // Default Status (jika tidak dikenali)
    let statusColor = "var(--muted)";
    let statusText = "PENDING";
    let statusBorder = "var(--muted)";

    // LOGIKA STATUS LENGKAP (Agar sinkron dengan Detail)
    if(st==="paid" || st==="success" || st==="berhasil"){ 
        statusColor="var(--success)"; 
        statusText="PAID"; 
        statusBorder="var(--success)";
    }
    else if(st==="proses" || st==="processing"){ 
        statusColor="var(--yellow)"; 
        statusText="PROSES"; 
        statusBorder="var(--yellow)";
    }
    else if(st==="selesai" || st==="completed" || st==="done"){ 
        statusColor="#00ff9c"; // Warna Neon
        statusText="SELESAI"; 
        statusBorder="#00ff9c";
    }
    else if(st==="canceled" || st==="cancelled" || st==="gagal"){ 
        statusColor="var(--danger)"; 
        statusText="CANCELED"; 
        statusBorder="var(--danger)";
    }
    
    const created = o.createdAt?.toDate ? o.createdAt.toDate() : (o.createdAt?.seconds ? new Date(o.createdAt.seconds*1000) : (o.createdAt ? new Date(o.createdAt) : null));
    const when = created ? created.toLocaleString("id-ID",{dateStyle:"short", timeStyle:"short"}) : "-";
    
    const firstItemName = (o.items && o.items[0] && o.items[0].name) ? o.items[0].name : "Order #" + o.id.substring(0,6);
    const itemCount = (o.items && o.items.length) ? o.items.length : 0;

    return `
      <div class="pixel-card product" style="cursor:pointer; position:relative; overflow:hidden;" onclick="openTxDetail('${o.id}')">
        <div style="position:absolute; left:0; top:0; bottom:0; width:4px; background:${statusColor};"></div>
        
        <div class="row" style="justify-content:space-between; margin-left:8px;">
          <div class="name" style="max-width:65%;">${escapeHtml(firstItemName)} ${itemCount > 1 ? `(+${itemCount-1})` : ''}</div>
          
          <div style="font-size:9px; padding:4px 8px; border-radius:6px; color:${statusColor}; border:1px solid ${statusBorder}; font-weight:bold; letter-spacing:1px;">
            ${statusText}
          </div>
        </div>

        <div class="meta" style="margin-left:8px;">${escapeHtml(when)} ‚Ä¢ Total: <span style="color:var(--text); font-weight:bold;">${escapeHtml(fmtRp(o.total||0))}</span></div>
        
        <div class="small" style="margin-top:6px; margin-left:8px; color:var(--cyan); font-size:9px; display:flex; align-items:center; gap:4px;">
           <span>‚ÑπÔ∏è</span> Ketuk untuk detail & bukti pembayaran
        </div>
      </div>
    `;
  }).join("");
}

// GANTI SELURUH FUNGSI window.openTxDetail DENGAN INI:

window.openTxDetail = function(orderId){
  if(!State.ordersRows) return;
  const order = State.ordersRows.find(o => o.id === orderId);
  if(!order) return;

  // Sembunyikan tombol tutup kecil bawaan di header (agar tidak ganda)
  const oldCloseBtn = document.getElementById("btnCloseTxDetail");
  if(oldCloseBtn) oldCloseBtn.style.display = "none";

  const st = String(order.status||"pending").toLowerCase();
  let statusBadgeColor = "var(--muted)";
  let statusBadgeText = "PENDING";
  
  // Logic Warna Status
  if(st==="paid"){ statusBadgeColor="var(--success)"; statusBadgeText="PAID"; }
  if(st==="proses"){ statusBadgeColor="var(--yellow)"; statusBadgeText="PROSES"; }
  if(st==="selesai"){ statusBadgeColor="#00ff9c"; statusBadgeText="SELESAI"; } 
  if(st==="canceled"||st==="cancelled"){ statusBadgeColor="var(--danger)"; statusBadgeText="CANCELED"; }

  const created = order.createdAt?.toDate ? order.createdAt.toDate() : (order.createdAt?.seconds ? new Date(order.createdAt.seconds*1000) : (order.createdAt ? new Date(order.createdAt) : null));
  const dateStr = created ? created.toLocaleString("id-ID") : "-";

  // Ubah Border Modal jadi Hijau Neon
  const modalBox = document.querySelector("#txDetailModal .modal");
  if(modalBox) {
      modalBox.style.border = "2px solid #00ff9c";
      modalBox.style.boxShadow = "0 0 15px rgba(0, 255, 156, 0.2)";
  }

  // --- HTML CONTENT (Pastikan tombol hanya ditulis 1 kali di sini) ---
  let html = `
    <button class="pixel-btn" 
            style="width:100%; margin-bottom:15px; background:rgba(5, 40, 40, 0.8); border:2px solid #00ff9c; color:#fff; font-weight:bold; font-size:12px; padding:12px; box-shadow: 0 4px 0 rgba(0,255,156,0.2);" 
            onclick="document.getElementById('txDetailModal').classList.remove('show')">
      Tutup
    </button>

    <div class="tx-detail-row">
      <span class="tx-detail-label">ID Order</span>
      <span class="tx-detail-val" style="font-family:monospace; font-size:10px;">${order.id}</span>
    </div>
    <div class="tx-detail-row">
      <span class="tx-detail-label">Tanggal</span>
      <span class="tx-detail-val">${dateStr}</span>
    </div>
    <div class="tx-detail-row">
      <span class="tx-detail-label">Status</span>
      <span class="tx-detail-val" style="color:${statusBadgeColor}; font-weight:bold; text-transform:uppercase; text-shadow: 0 0 5px ${statusBadgeColor};">${statusBadgeText}</span>
    </div>
    <div class="tx-detail-row">
      <span class="tx-detail-label">Metode Bayar</span>
      <span class="tx-detail-val">${escapeHtml(order.paymentMethod || "-")}</span>
    </div>
    <div class="tx-detail-row" style="border-bottom:none;">
      <span class="tx-detail-label">Total</span>
      <span class="tx-detail-val" style="font-size:12px; font-weight:bold;">${escapeHtml(fmtRp(order.total||0))}</span>
    </div>
  `;

  // --- DATA PESANAN / AKUN ---
  if (order.deliveryData) {
    html += `
      <div style="margin-top:15px; padding:12px; background:rgba(0, 255, 156, 0.05); border:2px dashed #00ff9c; border-radius:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span style="font-size:10px; color:#00ff9c; font-weight:bold;">üéÆ DATA PESANAN / AKUN:</span>
          <button style="font-size:9px; background:#00ff9c; color:#000; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:bold;" onclick="navigator.clipboard.writeText(\`${order.deliveryData}\`).then(()=>alert('Data disalin!'))">SALIN</button>
        </div>
        <div style="font-family:monospace; font-size:11px; color:#fff; white-space:pre-wrap; word-break:break-all; background:rgba(0,0,0,0.4); padding:10px; border-radius:8px;">${escapeHtml(order.deliveryData)}</div>
      </div>
    `;
  }

  // --- ITEM PESANAN ---
  html += `
    <div style="margin-top:15px; font-size:12px; font-weight:bold; color:#ffe066; margin-bottom:8px;">Item Pesanan:</div>
    <div class="tx-item-list" style="border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.3);">
  `;

  if(order.items && Array.isArray(order.items)){
    order.items.forEach(it => {
      html += `
        <div class="tx-item">
          <span style="font-weight:bold; color:#fff;">${escapeHtml(it.name)} <span style="font-size:9px; color:#aaa;">x${it.qty}</span></span>
          <span style="color:#00ff9c;">${fmtRp(it.price)}</span>
        </div>
      `;
    });
  } else {
    html += `<div class="small" style="text-align:center; padding:10px;">Data item tidak tersedia.</div>`;
  }
  
  html += `</div>`;

  // --- TOMBOL BUKTI ---
  if(order.paymentProofUrl){
    html += `
      <div style="margin-top:16px; text-align:center;">
        <a href="${escapeHtml(order.paymentProofUrl)}" target="_blank" style="display:block; width:100%; background:#ffe066; color:#000; padding:10px 0; border-radius:8px; text-decoration:none; font-weight:bold; font-size:11px; border:2px solid #000; box-shadow:0 4px 0 rgba(0,0,0,0.5);">[ Lihat bukti pembayaran ]</a>
      </div>
    `;
  }

  UI.txDetailContent.innerHTML = html;
  openModal(UI.txDetailModal);
};

// GANTI LISTENER UI.btnSubmitOrder DENGAN INI:

UI.btnSubmitOrder.addEventListener("click", async ()=>{
  const chk = requireVerifiedUser();
  if(!chk.ok){ showToast(chk.msg); openLogin(); return; }

  let itemsToProcess = [];
  let totalToPay = 0;
  let isDirectBuy = false;

  if (State.directCheckoutItem) {
      itemsToProcess = [State.directCheckoutItem];
      totalToPay = itemsToProcess[0].price * itemsToProcess[0].qty;
      isDirectBuy = true;
  } else {
      if(!State.cart.length){ showToast("Keranjang kosong"); return; }
      itemsToProcess = State.cart;
      totalToPay = cartSum();
      isDirectBuy = false;
  }

  const email = safeStr(UI.coEmail.value).trim();
  const wa = safeStr(UI.coWA.value).trim().replace(/[^0-9]/g,"");
  const name = safeStr(UI.coName.value).trim();
  const payId = safeStr(UI.coPayMethod.value).trim();
  const file = UI.coProof.files?.[0];
  const proofUrlExisting = safeStr(UI.coProofUrl?.value).trim();
  
  // ‚úÖ TAMBAHAN: Ambil catatan dari form
  const notes = safeStr($("#coNotes")?.value || "").trim();

  if(!email){ showToast("Email aktif wajib diisi"); return; }
  if(!wa){ showToast("Nomor WA wajib diisi"); return; }
  if(!payId){ showToast("Pilih metode pembayaran"); return; }

  let proofUrl = proofUrlExisting;
  if(!proofUrl){
    if(!file){ showToast("Upload bukti transfer atau gunakan tombol Upload Bukti"); return; }
    showLoader("Upload bukti...");
    try{
      proofUrl = await uploadToCloudinary(file, "bys/orders");
      if(UI.coProofUrl) UI.coProofUrl.value = proofUrl;
      if(UI.proofStatus) UI.proofStatus.textContent = "Bukti terupload.";
    }catch(e){
      console.error(e);
      hideLoader();
      showToast("Upload gagal: " + (e?.message||"error"));
      return;
    }
  }

  showLoader("Membuat order...");
  try{
    const itemsPayload = itemsToProcess.map(it=>({ 
        subKey: it.subKey || "-", 
        id: it.id, 
        name: it.name, 
        price: it.price, 
        qty: it.qty 
    }));
    
    const pay = (State.paymentMethods||[]).find(p=>p.id===payId) || {};

    // Buat order di Firestore
    const docRef = await addDoc(collection(db,"orders"), {
      uid: chk.user.uid,
      email,
      wa,
      name: name || (chk.user.displayName||""),
      items: itemsPayload,
      total: totalToPay,
      paymentMethod: pay.label || payId,
      paymentMethodId: payId,
      paymentProofUrl: proofUrl,
      notes: notes || "", // ‚úÖ SIMPAN CATATAN
      status: "pending",
      createdAt: serverTimestamp()
    });

    // Kirim notifikasi Telegram
    try {
      const WORKER_URL = "https://rapid-moon-94a5.idham-abiem.workers.dev/";
      
      const notificationData = {
        orderId: docRef.id,
        name: name || (chk.user.displayName || "-"),
        email: email,
        wa: wa,
        total: totalToPay,
        paymentMethod: pay.label || payId,
        notes: notes || "-", // ‚úÖ KIRIM CATATAN KE TELEGRAM
        items: itemsPayload.map(it => ({
          name: it.name,
          qty: it.qty,
          price: it.price
        }))
      };
      
      const notifResponse = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(notificationData)
      });
      
      if (notifResponse.ok) {
        console.log("‚úÖ Notifikasi Telegram terkirim!");
      } else {
        console.warn("‚ö†Ô∏è Notifikasi gagal:", notifResponse.status);
      }
      
    } catch (notifError) {
      console.error("‚ùå Error notifikasi:", notifError);
    }

    // Kosongkan keranjang jika bukan direct buy
    if (!isDirectBuy) {
        State.cart = []; 
        saveCart(); 
        updateCartBadge(); 
        renderCart();
    }
    
    State.directCheckoutItem = null;
    
    showToast("Order berhasil dibuat!");
    
    // ‚úÖ RESET FORM CHECKOUT
    if(UI.coProof) UI.coProof.value = "";
    if(UI.coProofUrl) UI.coProofUrl.value = "";
    if(UI.coProofHint) UI.coProofHint.textContent = "";
    if(UI.proofStatus) UI.proofStatus.textContent = "";
    if(UI.coName) UI.coName.value = "";
    if(UI.coWA) UI.coWA.value = "";
    if(UI.coPayMethod) UI.coPayMethod.selectedIndex = 0;
    if($("#coNotes")) $("#coNotes").value = ""; // ‚úÖ RESET CATATAN
    
    closeModal(UI.checkoutModal);
    setActiveTab("transaksi");
    
  }catch(e){
    console.error(e);
    showToast("Gagal membuat order: " + (e?.message||"error"));
  }finally{ 
    hideLoader(); 
  }
});

UI.coProof.addEventListener("change", ()=>{
  const f = UI.coProof.files?.[0];
  if(!f){ UI.coProofHint.textContent=""; return; }
  if(!f.type.startsWith("image/")){ UI.coProofHint.textContent="File harus gambar"; UI.coProof.value=""; return; }
  if(f.size>10*1024*1024){ UI.coProofHint.textContent="Ukuran max 10MB"; UI.coProof.value=""; return; }
  UI.coProofHint.textContent = `OK: ${f.name} (${Math.round(f.size/1024)} KB)`;

});

if(UI.btnUploadProof && !proofUploadBound){
  proofUploadBound = true;
  UI.btnUploadProof.addEventListener("click", async ()=>{
    const chk = requireVerifiedUser();
    if(!chk.ok){ showToast(chk.msg); openLogin(); return; }
    const file = UI.coProof.files?.[0];
    if(!file){ showToast("Pilih file bukti dulu"); return; }
    showLoader("Upload bukti...");
    try{
      const url = await uploadToCloudinary(file, "bys/orders");
      if(UI.coProofUrl) UI.coProofUrl.value = url;
      if(UI.proofStatus) UI.proofStatus.textContent = "Bukti terupload.";
      showToast("Upload berhasil");
    }catch(e){
      console.error(e);
      showToast("Upload gagal: " + (e?.message||"error"));
    }finally{ hideLoader(); }
  });
}

/* ===== URL ROUTING SYSTEM ===== */

// Generate URL untuk kategori/sub/produk
function generateUrl(type, params){
  const base = location.origin + location.pathname;
  let hash = '';
  
  if(type === 'category' && params.mainKey){
    hash = `#category/${encodeURIComponent(params.mainKey)}`;
  }
  else if(type === 'subcategory' && params.mainKey && params.subKey){
    hash = `#category/${encodeURIComponent(params.mainKey)}/sub/${encodeURIComponent(params.subKey)}`;
  }
  else if(type === 'product' && params.subKey && params.productId){
    hash = `#product/${encodeURIComponent(params.subKey)}/${encodeURIComponent(params.productId)}`;
  }
  
  return base + hash;
}

// Parse URL dan navigasi ke halaman yang sesuai
async function parseAndNavigate(){
  const hash = location.hash.slice(1); // Hilangkan #
  if(!hash) return;
  
  const parts = hash.split('/');
  
  // Format: #category/MAIN_KEY
  if(parts[0] === 'category' && parts[1]){
    const mainKey = decodeURIComponent(parts[1]);
    
    // Sub category: #category/MAIN_KEY/sub/SUB_KEY
    if(parts[2] === 'sub' && parts[3]){
      const subKey = decodeURIComponent(parts[3]);
      State.level = "product";
      State.pickedMain = mainKey;
      State.pickedSub = subKey;
      await ensureProductsLoaded(subKey);
      setActiveTab("produk");
      renderLevel();
    }
    // Category only
    else {
      State.level = "sub";
      State.pickedMain = mainKey;
      State.pickedSub = null;
      setActiveTab("produk");
      renderLevel();
    }
  }
  // Format: #product/SUB_KEY/PRODUCT_ID
  else if(parts[0] === 'product' && parts[1] && parts[2]){
    const subKey = decodeURIComponent(parts[1]);
    const productId = decodeURIComponent(parts[2]);
    
    State.level = "product";
    State.pickedSub = subKey;
    await ensureProductsLoaded(subKey);
    setActiveTab("produk");
    renderLevel();
    
    // Auto-scroll ke produk
    setTimeout(()=>{
      const prodEl = $(`[data-product-id="${productId}"]`);
      if(prodEl) prodEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
  }
}

// Copy link ke clipboard
async function copyProductLink(type, params){
  const url = generateUrl(type, params);
  try{
    await navigator.clipboard.writeText(url);
    showToast("Link disalin!");
  }catch(e){
    // Fallback untuk browser lama
    const temp = document.createElement('textarea');
    temp.value = url;
    temp.style.position = 'fixed';
    temp.style.opacity = '0';
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
    showToast("Link disalin!");
  }
}

// Listen untuk perubahan URL
window.addEventListener('hashchange', parseAndNavigate);

/* ===== HOME PAGE FUNCTIONS ===== */

// Render Popular Products (stok sedikit atau best seller)
async function renderPopularProducts(){
  const container = $("#popularProductsGrid");
  if(!container) return;

  try {
    // Ambil semua produk dari semua sub kategori
    const allProducts = [];
    
    // Loop through cached products
    for (const [subKey, products] of State.productsCache.entries()) {
      products.forEach(prod => {
        const stockNum = (prod.stock === 0 || prod.stock === "0") ? 0 : (Number(prod.stock) || null);
        const status = String(prod.status || "").toLowerCase();
        const isSold = (status === "sold") || (prod.available === false) || (stockNum === 0);
        
        if (!isSold && stockNum !== null && stockNum <= 10) {
          allProducts.push({ ...prod, subKey, stockNum });
        }
      });
    }

    // Sort by stock (paling sedikit dulu)
    allProducts.sort((a, b) => a.stockNum - b.stockNum);
    
    // Ambil 6 produk pertama
    const popular = allProducts.slice(0, 6);

    if (popular.length === 0) {
      container.innerHTML = `
        <div class="empty-state" style="grid-column:1/-1;">
          <div class="empty-icon">üì¶</div>
          <div class="empty-text">Belum ada produk populer</div>
        </div>
      `;
      return;
    }

    container.innerHTML = popular.map(prod => `
      <div class="mini-product-card" data-subkey="${escapeHtml(prod.subKey)}" data-prodid="${escapeHtml(prod.id)}">
        ${prod.image ? `<img class="mini-prod-img lazy-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect fill='%230b1220' width='200' height='200'/%3E%3C/svg%3E" data-src="${escapeHtml(normalizeImageUrl(prod.image))}" alt="${escapeHtml(prod.name)}" loading="lazy">` : `<div class="mini-prod-img" style="background:#0b1220"></div>`}
        <div class="mini-prod-info">
          <div class="mini-prod-name" title="${escapeHtml(prod.name)}">${escapeHtml(prod.name)}</div>
          <div class="mini-prod-footer">
            <div class="mini-prod-price">${fmtRp(prod.priceNum || prod.price || 0)}</div>
            <div class="stock-badge">Stok: ${prod.stockNum}</div>
          </div>
        </div>
      </div>
    `).join("");

    // Event listener untuk klik produk
    $$(".mini-product-card").forEach(card => {
      card.addEventListener("click", async () => {
        const subKey = card.getAttribute("data-subkey");
        const prodId = card.getAttribute("data-prodid");
        
        State.level = "product";
        State.pickedSub = subKey;
        await ensureProductsLoaded(subKey);
        setActiveTab("produk");
        renderLevel();
        
        // Auto scroll ke produk
        setTimeout(() => {
          const prodEl = $(`[data-product-id="${prodId}"]`);
          if (prodEl) prodEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      });
    });

  // ‚úÖ INIT LAZY LOADING untuk popular products
    setTimeout(() => initLazyImages(), 200);

  } catch(e) {
    console.error("Error rendering popular products:", e);
    container.innerHTML = `<div class="small" style="grid-column:1/-1; text-align:center; color:var(--danger);">Gagal memuat produk</div>`;
  }
}

// Render Popular Categories (dengan jumlah sub terbanyak)
function renderPopularCategories(){
  const container = $("#popularCategoriesGrid");
  if(!container) return;

  try {
    // Hitung jumlah sub per kategori
    const categoryCount = {};
    
    State.subCats.forEach(sub => {
      const catId = sub.categoryId || "__legacy__";
      categoryCount[catId] = (categoryCount[catId] || 0) + 1;
    });

    // Ambil main categories dan tambahkan count
    const categoriesWithCount = State.mainCats.map(cat => ({
      ...cat,
      subCount: categoryCount[cat.key] || 0
    }));

    // Sort by sub count (terbanyak dulu)
    categoriesWithCount.sort((a, b) => b.subCount - a.subCount);

    // Ambil 6 kategori pertama
    const popular = categoriesWithCount.slice(0, 6);

    if (popular.length === 0) {
      container.innerHTML = `
        <div class="empty-state" style="grid-column:1/-1;">
          <div class="empty-icon">üìÅ</div>
          <div class="empty-text">Belum ada kategori</div>
        </div>
      `;
      return;
    }

    container.innerHTML = popular.map(cat => `
      <div class="mini-cat-card" data-catkey="${escapeHtml(cat.key)}">
        ${cat.icon ? `<img class="mini-cat-icon lazy-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Crect fill='%230b1220' width='48' height='48'/%3E%3C/svg%3E" data-src="${escapeHtml(cat.icon)}" alt="${escapeHtml(cat.label)}" loading="lazy">` : `<div class="mini-cat-icon" style="font-size:32px;">üìÅ</div>`}
        <div class="mini-cat-name">${escapeHtml(cat.label)}</div>
        <div class="mini-cat-count">${cat.subCount} Sub Kategori</div>
      </div>
    `).join("");

    // Event listener untuk klik kategori
    $$(".mini-cat-card").forEach(card => {
      card.addEventListener("click", () => {
        const catKey = card.getAttribute("data-catkey");
        State.level = "sub";
        State.pickedMain = catKey;
        State.pickedSub = null;
        setActiveTab("produk");
        renderLevel();
      });
    });

  // ‚úÖ INIT LAZY LOADING untuk popular categories
    setTimeout(() => initLazyImages(), 200);

  } catch(e) {
    console.error("Error rendering popular categories:", e);
    container.innerHTML = `<div class="small" style="grid-column:1/-1; text-align:center; color:var(--danger);">Gagal memuat kategori</div>`;
  }
}

// Update Stats Counter dengan animasi
function updateStatsCounter(){
  // Count products
  let totalProducts = 0;
  for (const products of State.productsCache.values()) {
    totalProducts += products.length;
  }

  // Count categories
  const totalCategories = State.mainCats.length || State.legacyCats.length;

  // Count orders (dari user yang login)
  const totalOrders = (State.ordersRows || []).length;

  // Animate counting
  animateCounter("statProducts", totalProducts);
  animateCounter("statCategories", totalCategories);
  animateCounter("statOrders", totalOrders);
}

// Animasi counter (count up effect)
function animateCounter(id, target){
  const el = $(`#${id}`);
  if (!el) return;

  const duration = 1000; // 1 detik
  const start = 0;
  const increment = target / (duration / 16); // 60fps
  let current = start;

  const timer = setInterval(() => {
    current += increment;
    if (current >= target) {
      el.textContent = target;
      clearInterval(timer);
    } else {
      el.textContent = Math.floor(current);
    }
  }, 16);
}

// Load all subcategories data untuk popular products
async function loadAllSubcategoriesData(){
  try {
    // Ambil semua subcategories yang aktif
    const allSubs = [...State.subCats, ...State.legacyCats];
    
    // Load produk dari 10 sub pertama untuk performa
    const subsToLoad = allSubs.slice(0, 10);
    
    for (const sub of subsToLoad) {
      const subKey = sub.subKey || sub.key || sub.id;
      if (subKey && !State.productsCache.has(subKey)) {
        await ensureProductsLoaded(subKey);
      }
    }
  } catch(e) {
    console.error("Error loading subcategories data:", e);
  }
}

// Event listeners untuk quick actions
function bindQuickActions(){
  const quickCheckOrder = $("#quickCheckOrder");
  const quickTopUp = $("#quickTopUp");
  const viewAllProducts = $("#viewAllProducts");
  const viewAllCategories = $("#viewAllCategories");
  
  // ‚úÖ TAMBAHKAN INI
  const btnViewAllTransactions = $("#btnViewAllTransactions");

  if (quickCheckOrder) {
    quickCheckOrder.addEventListener("click", () => {
      setActiveTab("transaksi");
    });
  }

  if (quickTopUp) {
    quickTopUp.addEventListener("click", () => {
      setActiveTab("produk");
    });
  }

  if (viewAllProducts) {
    viewAllProducts.addEventListener("click", () => {
      setActiveTab("produk");
    });
  }

  if (viewAllCategories) {
    viewAllCategories.addEventListener("click", () => {
      setActiveTab("produk");
    });
  }
  
  // ‚úÖ TAMBAHKAN EVENT LISTENER INI
  if (btnViewAllTransactions) {
    btnViewAllTransactions.addEventListener("click", () => {
      setActiveTab("transaksi");
    });
  }
}

// Init Home Page
async function initHomePage(){
  updateStatsCounter();
  bindQuickActions();
  
  // Load data untuk popular products
  await loadAllSubcategoriesData();
  
  // Render sections
  renderPopularProducts();
  renderPopularCategories();
}

/* ===== RENDER CONTACT BUTTONS IN SETTINGS TAB ===== */
function renderSettingsContacts(){
  const container = $("#contactButtons");
  if(!container) return;
  
  const contacts = State.socialLinks || State.aboutItems || [];
  
  if(!contacts.length){
    container.innerHTML = `<div class="small" style="text-align:center; grid-column:1/-1;">Kontak belum tersedia</div>`;
    return;
  }
  
  container.innerHTML = contacts.map(item => {
    const iconMap = {
      'whatsapp': 'üì±',
      'telegram': '‚úàÔ∏è',
      'instagram': 'üì∑',
      'email': 'üìß',
      'facebook': 'üë•',
      'twitter': 'üê¶',
      'tiktok': 'üéµ',
      'discord': 'üí¨'
    };
    
    // Get label and clean it
    const fullLabel = (item.title || item.label || "Kontak").trim();
    const label = fullLabel.toLowerCase();
    
    // Auto-detect emoji based on label
    let emoji = 'üîó';
    Object.keys(iconMap).forEach(key => {
      if(label.includes(key)) emoji = iconMap[key];
    });
    
    // Jika ada icon di data dan bukan URL, gunakan itu
    if(item.icon && !item.icon.includes('/') && !item.icon.includes('http')){
      emoji = item.icon;
    }
    
    // Potong label jika terlalu panjang
    let displayLabel = fullLabel;
    if(displayLabel.length > 15){
      displayLabel = displayLabel.substring(0, 15) + '...';
    }
    
    return `
      <a href="${escapeHtml(item.url || '#')}" target="_blank" rel="noopener" class="pixel-btn secondary">
        <span>${emoji}</span>
        <span>${escapeHtml(displayLabel)}</span>
      </a>
    `;
  }).join("");
}

/* ===== SETTINGS TAB BUTTON LISTENERS ===== */

// Bind buttons (dipanggil di boot)
function bindSettingsButtons(){
  // Syarat & Ketentuan
  const btnTOS = $("#btnTOS");
  if(btnTOS){
    bindOnce(btnTOS, "tos", "click", ()=>{
      alert("üìÑ SYARAT & KETENTUAN\n\n1. Semua transaksi bersifat final\n2. Pastikan data akun benar sebelum order\n3. Proses 5-30 menit (jam kerja)\n4. Refund jika order gagal diproses\n5. Gunakan akun pribadi, bukan akun pinjaman");
    });
  }

  // Kebijakan Privasi
  const btnPrivacy = $("#btnPrivacy");
  if(btnPrivacy){
    bindOnce(btnPrivacy, "privacy", "click", ()=>{
      alert("üîí KEBIJAKAN PRIVASI\n\nKami menjaga privasi Anda:\n- Data hanya untuk proses order\n- Tidak dijual ke pihak ketiga\n- Bukti transfer dihapus setelah 7 hari\n- Password di-enkripsi\n- Hak akses sesuai kebutuhan");
    });
  }

  // Kebijakan Refund
  const btnRefund = $("#btnRefund");
  if(btnRefund){
    bindOnce(btnRefund, "refund", "click", ()=>{
      alert("üí∞ KEBIJAKAN PENGEMBALIAN DANA\n\n‚úÖ Refund 100% jika:\n- Order tidak dapat diproses\n- Stok habis setelah bayar\n- Kesalahan dari pihak admin\n\n‚ùå Tidak dapat refund jika:\n- Sudah diproses/dikirim\n- Kesalahan input data buyer\n- Order sudah >24 jam");
    });
  }

  // Report Issue
  const btnReport = $("#btnReportIssue");
  if(btnReport){
    bindOnce(btnReport, "report", "click", ()=>{
      const issue = prompt("üêõ LAPORKAN MASALAH\n\nJelaskan masalah yang Anda alami:");
      if(issue && issue.trim()){
        showToast("Laporan terkirim! Terima kasih.");
        console.log("User Report:", issue);
        // TODO: Kirim ke database atau email admin
      }
    });
  }

  // Feedback
  const btnFeedback = $("#btnFeedback");
  if(btnFeedback){
    bindOnce(btnFeedback, "feedback", "click", ()=>{
      const feedback = prompt("üí° SARAN & FEEDBACK\n\nBagikan ide/saran Anda untuk BYS Mart:");
      if(feedback && feedback.trim()){
        showToast("Feedback terkirim! Terima kasih.");
        console.log("User Feedback:", feedback);
        // TODO: Simpan ke database
      }
    });
  }
}

/* ===== APP BOOT ===== */
function boot(){
  const y = new Date().getFullYear();
  if(UI.yearNow) UI.yearNow.textContent = String(y);
  if(UI.yearNow2) UI.yearNow2.textContent = String(y);

  setActiveTab("home");
  loadCart();
  updateCartBadge();

  startListeners();
  // ‚úÖ HAPUS: renderSettings() (tidak dipakai lagi)
  
  // Fetch static data
  fetchStaticData();
  
  // ‚úÖ BIND SETTINGS BUTTONS
  setTimeout(()=>{
    bindSettingsButtons();
  }, 1000);
  
  // ‚úÖ LOAD ANNOUNCEMENTS (POPUP + BANNER)
  setTimeout(()=>{
    loadAnnouncements();
  }, 1500);
  
  // ‚úÖ INIT HOME PAGE (NEW)
  setTimeout(()=>{
    initHomePage();
  }, 2000);
  
  // Parse URL saat halaman load
  setTimeout(()=>{
    parseAndNavigate();
  }, 800);
}


onAuthStateChanged(auth, (user)=>{
  State.user = user || null;
  UI.btnLogin.textContent = State.user ? "User" : "Login";
  renderProfile();
  // ‚úÖ HAPUS: renderSettings() (tidak dipakai lagi)
});

boot();